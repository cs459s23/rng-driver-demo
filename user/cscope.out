cscope 15 $HOME/homework-1-defreez/user               0000088048
	@cat.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

5 
	gbuf
[512];

8 
	$ˇt
(
fd
)

10 
n
;

12 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0) {

13 i‡(
	`wrôe
(1, 
buf
, 
n
) !=Ç) {

14 
	`Ârötf
(2, "cat: writeÉrror\n");

15 
	`exô
(1);

18 if(
n
 < 0){

19 
	`Ârötf
(2, "cat:ÑeadÉrror\n");

20 
	`exô
(1);

22 
	}
}

25 
	$maö
(
¨gc
, *
¨gv
[])

27 
fd
, 
i
;

29 if(
¨gc
 <= 1){

30 
	`ˇt
(0);

31 
	`exô
(0);

34 
i
 = 1; i < 
¨gc
; i++){

35 if((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0){

36 
	`Ârötf
(2, "ˇt: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

37 
	`exô
(1);

39 
	`ˇt
(
fd
);

40 
	`˛o£
(
fd
);

44 
	}
}

	@demo.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"u£r/u£r.h
"

4 
	$maö
() {

5 
buf
[64];

8 
n
 = 
	`ªad
(0, 
buf
, (buf));

9 i‡(
n
 <= 0) {

10 
	`¥ötf
("readÉrror\n");

13 
	`wrôe
(1, 
buf
, 
n
);

16 
	`exô
(0);

17 
	}
}

	@echo.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 
i
;

10 
i
 = 1; i < 
¨gc
; i++){

11 
	`wrôe
(1, 
¨gv
[
i
], 
	`°æí
(argv[i]));

12 if(
i
 + 1 < 
¨gc
){

13 
	`wrôe
(1, " ", 1);

15 
	`wrôe
(1, "\n", 1);

18 
	`exô
(0);

19 
	}
}

	@forkdemo.c

1 
	~"kî√l/f˙é.h
"

2 
	~"kî√l/ty≥s.h
"

3 
	~"u£r/u£r.h
"

5 
	$maö
() {

6 
pid
;

8 
pid
 = 
	`f‹k
();

9 i‡(
pid
 == 0) {

10 
	`˛o£
(1);

11 
	`›í
("ouçut2.txt", 
O_WRONLY
 | 
O_CREATE
);

12 *
¨gv
[] = {"echo", "this is ", "a sepÖroc", 0};

13 
	`exec
("echo", 
¨gv
);

14 
	`¥ötf
("exec failed!\n");

15 
	`exô
(1);

17 
	`waô
((*) 0);

20 
	`exô
(0);

21 
	}
}

	@forktest.c

4 
	~"kî√l/ty≥s.h
"

5 
	~"kî√l/°©.h
"

6 
	~"u£r/u£r.h
"

8 
	#N
 1000

	)

11 
	$¥öt
(c⁄° *
s
)

13 
	`wrôe
(1, 
s
, 
	`°æí
(s));

14 
	}
}

17 
	$f‹kã°
()

19 
n
, 
pid
;

21 
	`¥öt
("forkÅest\n");

23 
n
=0;Ç<
N
;Ç++){

24 
pid
 = 
	`f‹k
();

25 if(
pid
 < 0)

27 if(
pid
 == 0)

28 
	`exô
(0);

31 if(
n
 =
N
){

32 
	`¥öt
("fork claimedÅo work NÅimes!\n");

33 
	`exô
(1);

36 ; 
n
 > 0;Ç--){

37 if(
	`waô
(0) < 0){

38 
	`¥öt
("wait stoppedÉarly\n");

39 
	`exô
(1);

43 if(
	`waô
(0) != -1){

44 
	`¥öt
("wait gotÅoo many\n");

45 
	`exô
(1);

48 
	`¥öt
("forkÅest OK\n");

49 
	}
}

52 
	$maö
()

54 
	`f‹kã°
();

55 
	`exô
(0);

56 
	}
}

	@grep.c

3 
	~"kî√l/ty≥s.h
"

4 
	~"kî√l/°©.h
"

5 
	~"u£r/u£r.h
"

7 
	gbuf
[1024];

8 
m©ch
(*, *);

11 
	$gªp
(*
∑âîn
, 
fd
)

13 
n
, 
m
;

14 *
p
, *
q
;

16 
m
 = 0;

17 (
n
 = 
	`ªad
(
fd
, 
buf
+
m
, (buf)-m-1)) > 0){

18 
m
 +
n
;

19 
buf
[
m
] = '\0';

20 
p
 = 
buf
;

21 (
q
 = 
	`°rchr
(
p
, '\n')) != 0){

22 *
q
 = 0;

23 if(
	`m©ch
(
∑âîn
, 
p
)){

24 *
q
 = '\n';

25 
	`wrôe
(1, 
p
, 
q
+1 -Ö);

27 
p
 = 
q
+1;

29 if(
m
 > 0){

30 
m
 -
p
 - 
buf
;

31 
	`memmove
(
buf
, 
p
, 
m
);

34 
	}
}

37 
	$maö
(
¨gc
, *
¨gv
[])

39 
fd
, 
i
;

40 *
∑âîn
;

42 if(
¨gc
 <= 1){

43 
	`Ârötf
(2, "usage: grepÖattern [file ...]\n");

44 
	`exô
(1);

46 
∑âîn
 = 
¨gv
[1];

48 if(
¨gc
 <= 2){

49 
	`gªp
(
∑âîn
, 0);

50 
	`exô
(0);

53 
i
 = 2; i < 
¨gc
; i++){

54 if((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0){

55 
	`¥ötf
("gªp: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

56 
	`exô
(1);

58 
	`gªp
(
∑âîn
, 
fd
);

59 
	`˛o£
(
fd
);

61 
	`exô
(0);

62 
	}
}

68 
m©chhîe
(*, *);

69 
m©ch°¨
(, *, *);

72 
	$m©ch
(*
ª
, *
ãxt
)

74 if(
ª
[0] == '^')

75  
	`m©chhîe
(
ª
+1, 
ãxt
);

77 if(
	`m©chhîe
(
ª
, 
ãxt
))

79 }*
ãxt
++ != '\0');

81 
	}
}

84 
	$m©chhîe
(*
ª
, *
ãxt
)

86 if(
ª
[0] == '\0')

88 if(
ª
[1] == '*')

89  
	`m©ch°¨
(
ª
[0],Ñe+2, 
ãxt
);

90 if(
ª
[0] == '$' &&Ñe[1] == '\0')

91  *
ãxt
 == '\0';

92 if(*
ãxt
!='\0' && (
ª
[0]=='.' ||Ñe[0]==*text))

93  
	`m©chhîe
(
ª
+1, 
ãxt
+1);

95 
	}
}

98 
	$m©ch°¨
(
c
, *
ª
, *
ãxt
)

101 if(
	`m©chhîe
(
ª
, 
ãxt
))

103 }*
ãxt
!='\0' && (*ãxt++==
c
 || c=='.'));

105 
	}
}

	@grind.c

5 
	~"kî√l/∑øm.h
"

6 
	~"kî√l/ty≥s.h
"

7 
	~"kî√l/°©.h
"

8 
	~"u£r/u£r.h
"

9 
	~"kî√l/fs.h
"

10 
	~"kî√l/f˙é.h
"

11 
	~"kî√l/sysˇŒ.h
"

12 
	~"kî√l/memœyout.h
"

13 
	~"kî√l/riscv.h
"

17 
	$do_ønd
(*
˘x
)

27 
hi
, 
lo
, 
x
;

30 
x
 = (*
˘x
 % 0x7ffffffe) + 1;

31 
hi
 = 
x
 / 127773;

32 
lo
 = 
x
 % 127773;

33 
x
 = 16807 * 
lo
 - 2836 * 
hi
;

34 i‡(
x
 < 0)

35 
x
 += 0x7fffffff;

37 
x
--;

38 *
˘x
 = 
x
;

39  (
x
);

40 
	}
}

42 
	gønd_√xt
 = 1;

45 
	$ønd
()

47  (
	`do_ønd
(&
ønd_√xt
));

48 
	}
}

51 
	$go
(
which_chûd
)

53 
fd
 = -1;

54 
buf
[999];

55 *
bªak0
 = 
	`sbrk
(0);

56 
uöt64
 
ôîs
 = 0;

58 
	`mkdú
("grindir");

59 if(
	`chdú
("grindir") != 0){

60 
	`¥ötf
("grind: chdir grindir failed\n");

61 
	`exô
(1);

63 
	`chdú
("/");

66 
ôîs
++;

67 if((
ôîs
 % 500) == 0)

68 
	`wrôe
(1, 
which_chûd
?"B":"A", 1);

69 
wh©
 = 
	`ønd
() % 23;

70 if(
wh©
 == 1){

71 
	`˛o£
(
	`›í
("grödú/../a", 
O_CREATE
|
O_RDWR
));

72 } if(
wh©
 == 2){

73 
	`˛o£
(
	`›í
("grödú/../grödú/../b", 
O_CREATE
|
O_RDWR
));

74 } if(
wh©
 == 3){

75 
	`u∆ök
("grindir/../a");

76 } if(
wh©
 == 4){

77 if(
	`chdú
("grindir") != 0){

78 
	`¥ötf
("grind: chdir grindir failed\n");

79 
	`exô
(1);

81 
	`u∆ök
("../b");

82 
	`chdú
("/");

83 } if(
wh©
 == 5){

84 
	`˛o£
(
fd
);

85 
fd
 = 
	`›í
("/grödú/../a", 
O_CREATE
|
O_RDWR
);

86 } if(
wh©
 == 6){

87 
	`˛o£
(
fd
);

88 
fd
 = 
	`›í
("/./grödú/./../b", 
O_CREATE
|
O_RDWR
);

89 } if(
wh©
 == 7){

90 
	`wrôe
(
fd
, 
buf
, (buf));

91 } if(
wh©
 == 8){

92 
	`ªad
(
fd
, 
buf
, (buf));

93 } if(
wh©
 == 9){

94 
	`mkdú
("grindir/../a");

95 
	`˛o£
(
	`›í
("a/../a/./a", 
O_CREATE
|
O_RDWR
));

96 
	`u∆ök
("a/a");

97 } if(
wh©
 == 10){

98 
	`mkdú
("/../b");

99 
	`˛o£
(
	`›í
("grödú/../b/b", 
O_CREATE
|
O_RDWR
));

100 
	`u∆ök
("b/b");

101 } if(
wh©
 == 11){

102 
	`u∆ök
("b");

103 
	`lök
("../grindir/./../a", "../b");

104 } if(
wh©
 == 12){

105 
	`u∆ök
("../grindir/../a");

106 
	`lök
(".././b", "/grindir/../a");

107 } if(
wh©
 == 13){

108 
pid
 = 
	`f‹k
();

109 if(
pid
 == 0){

110 
	`exô
(0);

111 } if(
pid
 < 0){

112 
	`¥ötf
("grind: fork failed\n");

113 
	`exô
(1);

115 
	`waô
(0);

116 } if(
wh©
 == 14){

117 
pid
 = 
	`f‹k
();

118 if(
pid
 == 0){

119 
	`f‹k
();

120 
	`f‹k
();

121 
	`exô
(0);

122 } if(
pid
 < 0){

123 
	`¥ötf
("grind: fork failed\n");

124 
	`exô
(1);

126 
	`waô
(0);

127 } if(
wh©
 == 15){

128 
	`sbrk
(6011);

129 } if(
wh©
 == 16){

130 if(
	`sbrk
(0Ë> 
bªak0
)

131 
	`sbrk
(-(sbrk(0Ë- 
bªak0
));

132 } if(
wh©
 == 17){

133 
pid
 = 
	`f‹k
();

134 if(
pid
 == 0){

135 
	`˛o£
(
	`›í
("a", 
O_CREATE
|
O_RDWR
));

136 
	`exô
(0);

137 } if(
pid
 < 0){

138 
	`¥ötf
("grind: fork failed\n");

139 
	`exô
(1);

141 if(
	`chdú
("../grindir/..") != 0){

142 
	`¥ötf
("grind: chdir failed\n");

143 
	`exô
(1);

145 
	`kûl
(
pid
);

146 
	`waô
(0);

147 } if(
wh©
 == 18){

148 
pid
 = 
	`f‹k
();

149 if(
pid
 == 0){

150 
	`kûl
(
	`gëpid
());

151 
	`exô
(0);

152 } if(
pid
 < 0){

153 
	`¥ötf
("grind: fork failed\n");

154 
	`exô
(1);

156 
	`waô
(0);

157 } if(
wh©
 == 19){

158 
fds
[2];

159 if(
	`pùe
(
fds
) < 0){

160 
	`¥ötf
("grind:Öipe failed\n");

161 
	`exô
(1);

163 
pid
 = 
	`f‹k
();

164 if(
pid
 == 0){

165 
	`f‹k
();

166 
	`f‹k
();

167 if(
	`wrôe
(
fds
[1], "x", 1) != 1)

168 
	`¥ötf
("grind:Öipe write failed\n");

169 
c
;

170 if(
	`ªad
(
fds
[0], &
c
, 1) != 1)

171 
	`¥ötf
("grind:ÖipeÑead failed\n");

172 
	`exô
(0);

173 } if(
pid
 < 0){

174 
	`¥ötf
("grind: fork failed\n");

175 
	`exô
(1);

177 
	`˛o£
(
fds
[0]);

178 
	`˛o£
(
fds
[1]);

179 
	`waô
(0);

180 } if(
wh©
 == 20){

181 
pid
 = 
	`f‹k
();

182 if(
pid
 == 0){

183 
	`u∆ök
("a");

184 
	`mkdú
("a");

185 
	`chdú
("a");

186 
	`u∆ök
("../a");

187 
fd
 = 
	`›í
("x", 
O_CREATE
|
O_RDWR
);

188 
	`u∆ök
("x");

189 
	`exô
(0);

190 } if(
pid
 < 0){

191 
	`¥ötf
("grind: fork failed\n");

192 
	`exô
(1);

194 
	`waô
(0);

195 } if(
wh©
 == 21){

196 
	`u∆ök
("c");

199 
fd1
 = 
	`›í
("c", 
O_CREATE
|
O_RDWR
);

200 if(
fd1
 < 0){

201 
	`¥ötf
("grind: create c failed\n");

202 
	`exô
(1);

204 if(
	`wrôe
(
fd1
, "x", 1) != 1){

205 
	`¥ötf
("grind: write c failed\n");

206 
	`exô
(1);

208 
°©
 
°
;

209 if(
	`f°©
(
fd1
, &
°
) != 0){

210 
	`¥ötf
("grind: fstat failed\n");

211 
	`exô
(1);

213 if(
°
.
size
 != 1){

214 
	`¥ötf
("gröd: f°©Ñï‹t†wr⁄g sizê%d\n", ()
°
.
size
);

215 
	`exô
(1);

217 if(
°
.
öo
 > 200){

218 
	`¥ötf
("gröd: f°©Ñï‹t†¸azy i-numbî %d\n", 
°
.
öo
);

219 
	`exô
(1);

221 
	`˛o£
(
fd1
);

222 
	`u∆ök
("c");

223 } if(
wh©
 == 22){

225 
Ø
[2], 
bb
[2];

226 if(
	`pùe
(
Ø
) < 0){

227 
	`Ârötf
(2, "grind:Öipe failed\n");

228 
	`exô
(1);

230 if(
	`pùe
(
bb
) < 0){

231 
	`Ârötf
(2, "grind:Öipe failed\n");

232 
	`exô
(1);

234 
pid1
 = 
	`f‹k
();

235 if(
pid1
 == 0){

236 
	`˛o£
(
bb
[0]);

237 
	`˛o£
(
bb
[1]);

238 
	`˛o£
(
Ø
[0]);

239 
	`˛o£
(1);

240 if(
	`dup
(
Ø
[1]) != 1){

241 
	`Ârötf
(2, "grind: dup failed\n");

242 
	`exô
(1);

244 
	`˛o£
(
Ø
[1]);

245 *
¨gs
[3] = { "echo", "hi", 0 };

246 
	`exec
("grödú/../echo", 
¨gs
);

247 
	`Ârötf
(2, "grind:Écho:Çot found\n");

248 
	`exô
(2);

249 } if(
pid1
 < 0){

250 
	`Ârötf
(2, "grind: fork failed\n");

251 
	`exô
(3);

253 
pid2
 = 
	`f‹k
();

254 if(
pid2
 == 0){

255 
	`˛o£
(
Ø
[1]);

256 
	`˛o£
(
bb
[0]);

257 
	`˛o£
(0);

258 if(
	`dup
(
Ø
[0]) != 0){

259 
	`Ârötf
(2, "grind: dup failed\n");

260 
	`exô
(4);

262 
	`˛o£
(
Ø
[0]);

263 
	`˛o£
(1);

264 if(
	`dup
(
bb
[1]) != 1){

265 
	`Ârötf
(2, "grind: dup failed\n");

266 
	`exô
(5);

268 
	`˛o£
(
bb
[1]);

269 *
¨gs
[2] = { "cat", 0 };

270 
	`exec
("/ˇt", 
¨gs
);

271 
	`Ârötf
(2, "grind: cat:Çot found\n");

272 
	`exô
(6);

273 } if(
pid2
 < 0){

274 
	`Ârötf
(2, "grind: fork failed\n");

275 
	`exô
(7);

277 
	`˛o£
(
Ø
[0]);

278 
	`˛o£
(
Ø
[1]);

279 
	`˛o£
(
bb
[1]);

280 
buf
[4] = { 0, 0, 0, 0 };

281 
	`ªad
(
bb
[0], 
buf
+0, 1);

282 
	`ªad
(
bb
[0], 
buf
+1, 1);

283 
	`ªad
(
bb
[0], 
buf
+2, 1);

284 
	`˛o£
(
bb
[0]);

285 
°1
, 
°2
;

286 
	`waô
(&
°1
);

287 
	`waô
(&
°2
);

288 if(
°1
 !0 || 
°2
 !0 || 
	`°rcmp
(
buf
, "hi\n") != 0){

289 
	`¥ötf
("gröd:Éxe¯pùñöêÁûed %d %d \"%s\"\n", 
°1
, 
°2
, 
buf
);

290 
	`exô
(1);

294 
	}
}

297 
	$ôî
()

299 
	`u∆ök
("a");

300 
	`u∆ök
("b");

302 
pid1
 = 
	`f‹k
();

303 if(
pid1
 < 0){

304 
	`¥ötf
("grind: fork failed\n");

305 
	`exô
(1);

307 if(
pid1
 == 0){

308 
ønd_√xt
 ^= 31;

309 
	`go
(0);

310 
	`exô
(0);

313 
pid2
 = 
	`f‹k
();

314 if(
pid2
 < 0){

315 
	`¥ötf
("grind: fork failed\n");

316 
	`exô
(1);

318 if(
pid2
 == 0){

319 
ønd_√xt
 ^= 7177;

320 
	`go
(1);

321 
	`exô
(0);

324 
°1
 = -1;

325 
	`waô
(&
°1
);

326 if(
°1
 != 0){

327 
	`kûl
(
pid1
);

328 
	`kûl
(
pid2
);

330 
°2
 = -1;

331 
	`waô
(&
°2
);

333 
	`exô
(0);

334 
	}
}

337 
	$maö
()

340 
pid
 = 
	`f‹k
();

341 if(
pid
 == 0){

342 
	`ôî
();

343 
	`exô
(0);

345 if(
pid
 > 0){

346 
	`waô
(0);

348 
	`¶ìp
(20);

349 
ønd_√xt
 += 1;

351 
	}
}

	@hello.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

5 
	$maö
() {

6 
	`¥ötf
("Hello, world!\n");

8 
	}
}

	@init.c

3 
	~"kî√l/ty≥s.h
"

4 
	~"kî√l/°©.h
"

5 
	~"kî√l/•ölock.h
"

6 
	~"kî√l/¶ì∂ock.h
"

7 
	~"kî√l/fs.h
"

8 
	~"kî√l/fûe.h
"

9 
	~"u£r/u£r.h
"

10 
	~"kî√l/f˙é.h
"

12 *
	g¨gv
[] = { "sh", 0 };

15 
	$maö
()

17 
pid
, 
wpid
;

19 if(
	`›í
("c⁄sﬁe", 
O_RDWR
) < 0){

20 
	`mknod
("c⁄sﬁe", 
CONSOLE
, 0);

21 
	`›í
("c⁄sﬁe", 
O_RDWR
);

23 
	`dup
(0);

24 
	`dup
(0);

27 
	`¥ötf
("init: starting sh\n");

28 
pid
 = 
	`f‹k
();

29 if(
pid
 < 0){

30 
	`¥ötf
("init: fork failed\n");

31 
	`exô
(1);

33 if(
pid
 == 0){

34 
	`exec
("sh", 
¨gv
);

35 
	`¥ötf
("init:Éxec sh failed\n");

36 
	`exô
(1);

42 
wpid
 = 
	`waô
((*) 0);

43 if(
wpid
 =
pid
){

46 } if(
wpid
 < 0){

47 
	`¥ötf
("init: waitÑeturnedánÉrror\n");

48 
	`exô
(1);

54 
	}
}

	@kill.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

6 
	$maö
(
¨gc
, **
¨gv
)

8 
i
;

10 if(
¨gc
 < 2){

11 
	`Ârötf
(2, "usage: killÖid...\n");

12 
	`exô
(1);

14 
i
=1; i<
¨gc
; i++)

15 
	`kûl
(
	`©oi
(
¨gv
[
i
]));

16 
	`exô
(0);

17 
	}
}

	@ln.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 if(
¨gc
 != 3){

9 
	`Ârötf
(2, "Usage:Ün oldÇew\n");

10 
	`exô
(1);

12 if(
	`lök
(
¨gv
[1],árgv[2]) < 0)

13 
	`Ârötf
(2, "lök %†%s: faûed\n", 
¨gv
[1],árgv[2]);

14 
	`exô
(0);

15 
	}
}

	@ls.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

4 
	~"kî√l/fs.h
"

7 
	$fmäame
(*
∑th
)

9 
buf
[
DIRSIZ
+1];

10 *
p
;

13 
p
=
∑th
+
	`°æí
(path);Ö >=Öath && *p != '/';Ö--)

15 
p
++;

18 if(
	`°æí
(
p
Ë>
DIRSIZ
)

19  
p
;

20 
	`memmove
(
buf
, 
p
, 
	`°æí
(p));

21 
	`mem£t
(
buf
+
	`°æí
(
p
), ' ', 
DIRSIZ
-strlen(p));

22  
buf
;

23 
	}
}

26 
	$ls
(*
∑th
)

28 
buf
[512], *
p
;

29 
fd
;

30 
dúít
 
de
;

31 
°©
 
°
;

33 if((
fd
 = 
	`›í
(
∑th
, 0)) < 0){

34 
	`Ârötf
(2, "ls: c™nŸ o≥¿%s\n", 
∑th
);

38 if(
	`f°©
(
fd
, &
°
) < 0){

39 
	`Ârötf
(2, "ls: c™nŸ sèà%s\n", 
∑th
);

40 
	`˛o£
(
fd
);

44 
°
.
ty≥
){

45 
T_DEVICE
:

46 
T_FILE
:

47 
	`¥ötf
("%†%d %d %l\n", 
	`fmäame
(
∑th
), 
°
.
ty≥
, st.
öo
, st.
size
);

50 
T_DIR
:

51 if(
	`°æí
(
∑th
Ë+ 1 + 
DIRSIZ
 + 1 >  
buf
){

52 
	`¥ötf
("ls:ÖathÅooÜong\n");

55 
	`°r˝y
(
buf
, 
∑th
);

56 
p
 = 
buf
+
	`°æí
(buf);

57 *
p
++ = '/';

58 
	`ªad
(
fd
, &
de
, (de)) == (de)){

59 if(
de
.
öum
 == 0)

61 
	`memmove
(
p
, 
de
.
«me
, 
DIRSIZ
);

62 
p
[
DIRSIZ
] = 0;

63 if(
	`°©
(
buf
, &
°
) < 0){

64 
	`¥ötf
("ls: c™nŸ sèà%s\n", 
buf
);

67 
	`¥ötf
("%†%d %d %d\n", 
	`fmäame
(
buf
), 
°
.
ty≥
, st.
öo
, st.
size
);

71 
	`˛o£
(
fd
);

72 
	}
}

75 
	$maö
(
¨gc
, *
¨gv
[])

77 
i
;

79 if(
¨gc
 < 2){

80 
	`ls
(".");

81 
	`exô
(0);

83 
i
=1; i<
¨gc
; i++)

84 
	`ls
(
¨gv
[
i
]);

85 
	`exô
(0);

86 
	}
}

	@mkdir.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 
i
;

10 if(
¨gc
 < 2){

11 
	`Ârötf
(2, "Usage: mkdir files...\n");

12 
	`exô
(1);

15 
i
 = 1; i < 
¨gc
; i++){

16 if(
	`mkdú
(
¨gv
[
i
]) < 0){

17 
	`Ârötf
(2, "mkdú: %†ÁûedÅÿ¸óã\n", 
¨gv
[
i
]);

22 
	`exô
(0);

23 
	}
}

	@printf.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

5 
	~<°d¨g.h
>

7 
	gdigôs
[] = "0123456789ABCDEF";

10 
	$putc
(
fd
, 
c
)

12 
	`wrôe
(
fd
, &
c
, 1);

13 
	}
}

16 
	$¥ötöt
(
fd
, 
xx
, 
ba£
, 
sgn
)

18 
buf
[16];

19 
i
, 
√g
;

20 
uöt
 
x
;

22 
√g
 = 0;

23 if(
sgn
 && 
xx
 < 0){

24 
√g
 = 1;

25 
x
 = -
xx
;

27 
x
 = 
xx
;

30 
i
 = 0;

32 
buf
[
i
++] = 
digôs
[
x
 % 
ba£
];

33 }(
x
 /
ba£
) != 0);

34 if(
√g
)

35 
buf
[
i
++] = '-';

37 --
i
 >= 0)

38 
	`putc
(
fd
, 
buf
[
i
]);

39 
	}
}

42 
	$¥öçå
(
fd
, 
uöt64
 
x
) {

43 
i
;

44 
	`putc
(
fd
, '0');

45 
	`putc
(
fd
, 'x');

46 
i
 = 0; i < ((
uöt64
Ë* 2); i++, 
x
 <<= 4)

47 
	`putc
(
fd
, 
digôs
[
x
 >> ((
uöt64
) * 8 - 4)]);

48 
	}
}

52 
	$v¥ötf
(
fd
, c⁄° *
fmt
, 
va_li°
 
≠
)

54 *
s
;

55 
c
, 
i
, 
°©e
;

57 
°©e
 = 0;

58 
i
 = 0; 
fmt
[i]; i++){

59 
c
 = 
fmt
[
i
] & 0xff;

60 if(
°©e
 == 0){

61 if(
c
 == '%'){

62 
°©e
 = '%';

64 
	`putc
(
fd
, 
c
);

66 } if(
°©e
 == '%'){

67 if(
c
 == 'd'){

68 
	`¥ötöt
(
fd
, 
	`va_¨g
(
≠
, ), 10, 1);

69 } if(
c
 == 'l') {

70 
	`¥ötöt
(
fd
, 
	`va_¨g
(
≠
, 
uöt64
), 10, 0);

71 } if(
c
 == 'x') {

72 
	`¥ötöt
(
fd
, 
	`va_¨g
(
≠
, ), 16, 0);

73 } if(
c
 == 'p') {

74 
	`¥öçå
(
fd
, 
	`va_¨g
(
≠
, 
uöt64
));

75 } if(
c
 == 's'){

76 
s
 = 
	`va_¨g
(
≠
, *);

77 if(
s
 == 0)

78 
s
 = "(null)";

79 *
s
 != 0){

80 
	`putc
(
fd
, *
s
);

81 
s
++;

83 } if(
c
 == 'c'){

84 
	`putc
(
fd
, 
	`va_¨g
(
≠
, 
uöt
));

85 } if(
c
 == '%'){

86 
	`putc
(
fd
, 
c
);

89 
	`putc
(
fd
, '%');

90 
	`putc
(
fd
, 
c
);

92 
°©e
 = 0;

95 
	}
}

98 
	$Ârötf
(
fd
, c⁄° *
fmt
, ...)

100 
va_li°
 
≠
;

102 
	`va_°¨t
(
≠
, 
fmt
);

103 
	`v¥ötf
(
fd
, 
fmt
, 
≠
);

104 
	}
}

107 
	$¥ötf
(c⁄° *
fmt
, ...)

109 
va_li°
 
≠
;

111 
	`va_°¨t
(
≠
, 
fmt
);

112 
	`v¥ötf
(1, 
fmt
, 
≠
);

113 
	}
}

	@rm.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

6 
	$maö
(
¨gc
, *
¨gv
[])

8 
i
;

10 if(
¨gc
 < 2){

11 
	`Ârötf
(2, "Usage:Ñm files...\n");

12 
	`exô
(1);

15 
i
 = 1; i < 
¨gc
; i++){

16 if(
	`u∆ök
(
¨gv
[
i
]) < 0){

17 
	`Ârötf
(2, "rm: %†ÁûedÅÿdñëe\n", 
¨gv
[
i
]);

22 
	`exô
(0);

23 
	}
}

	@sh.c

3 
	~"kî√l/ty≥s.h
"

4 
	~"u£r/u£r.h
"

5 
	~"kî√l/f˙é.h
"

8 
	#EXEC
 1

	)

9 
	#REDIR
 2

	)

10 
	#PIPE
 3

	)

11 
	#LIST
 4

	)

12 
	#BACK
 5

	)

14 
	#MAXARGS
 10

	)

16 
	scmd
 {

17 
	mty≥
;

20 
	sexeccmd
 {

21 
	mty≥
;

22 *
	m¨gv
[
MAXARGS
];

23 *
	mórgv
[
MAXARGS
];

26 
	sªdúcmd
 {

27 
	mty≥
;

28 
cmd
 *
	mcmd
;

29 *
	mfûe
;

30 *
	mefûe
;

31 
	mmode
;

32 
	mfd
;

35 
	spùecmd
 {

36 
	mty≥
;

37 
cmd
 *
	mÀ·
;

38 
cmd
 *
	mright
;

41 
	sli°cmd
 {

42 
	mty≥
;

43 
cmd
 *
	mÀ·
;

44 
cmd
 *
	mright
;

47 
	sbackcmd
 {

48 
	mty≥
;

49 
cmd
 *
	mcmd
;

52 
f‹k1
();

53 
∑nic
(*);

54 
cmd
 *
∑r£cmd
(*);

55 
	$runcmd
(
cmd
*Ë
	`__©åibuã__
((
n‹ëu∫
));

59 
	$runcmd
(
cmd
 *cmd)

61 
p
[2];

62 
backcmd
 *
bcmd
;

63 
execcmd
 *
ecmd
;

64 
li°cmd
 *
lcmd
;

65 
pùecmd
 *
pcmd
;

66 
ªdúcmd
 *
rcmd
;

68 if(
cmd
 == 0)

69 
	`exô
(1);

71 
cmd
->
ty≥
){

73 
	`∑nic
("runcmd");

75 
EXEC
:

76 
ecmd
 = (
execcmd
*)
cmd
;

77 if(
ecmd
->
¨gv
[0] == 0)

78 
	`exô
(1);

79 
	`exec
(
ecmd
->
¨gv
[0],Écmd->argv);

80 
	`Ârötf
(2, "exe¯%†Áûed\n", 
ecmd
->
¨gv
[0]);

83 
REDIR
:

84 
rcmd
 = (
ªdúcmd
*)
cmd
;

85 
	`˛o£
(
rcmd
->
fd
);

86 if(
	`›í
(
rcmd
->
fûe
,Ñcmd->
mode
) < 0){

87 
	`Ârötf
(2, "›í %†Áûed\n", 
rcmd
->
fûe
);

88 
	`exô
(1);

90 
	`runcmd
(
rcmd
->
cmd
);

93 
LIST
:

94 
lcmd
 = (
li°cmd
*)
cmd
;

95 if(
	`f‹k1
() == 0)

96 
	`runcmd
(
lcmd
->
À·
);

97 
	`waô
(0);

98 
	`runcmd
(
lcmd
->
right
);

101 
PIPE
:

102 
pcmd
 = (
pùecmd
*)
cmd
;

103 if(
	`pùe
(
p
) < 0)

104 
	`∑nic
("pipe");

105 if(
	`f‹k1
() == 0){

106 
	`˛o£
(1);

107 
	`dup
(
p
[1]);

108 
	`˛o£
(
p
[0]);

109 
	`˛o£
(
p
[1]);

110 
	`runcmd
(
pcmd
->
À·
);

112 if(
	`f‹k1
() == 0){

113 
	`˛o£
(0);

114 
	`dup
(
p
[0]);

115 
	`˛o£
(
p
[0]);

116 
	`˛o£
(
p
[1]);

117 
	`runcmd
(
pcmd
->
right
);

119 
	`˛o£
(
p
[0]);

120 
	`˛o£
(
p
[1]);

121 
	`waô
(0);

122 
	`waô
(0);

125 
BACK
:

126 
bcmd
 = (
backcmd
*)
cmd
;

127 if(
	`f‹k1
() == 0)

128 
	`runcmd
(
bcmd
->
cmd
);

131 
	`exô
(0);

132 
	}
}

135 
	$gëcmd
(*
buf
, 
nbuf
)

137 
	`wrôe
(2, "$ ", 2);

138 
	`mem£t
(
buf
, 0, 
nbuf
);

139 
	`gës
(
buf
, 
nbuf
);

140 if(
buf
[0] == 0)

143 
	}
}

146 
	$maö
()

148 
buf
[100];

149 
fd
;

152 (
fd
 = 
	`›í
("c⁄sﬁe", 
O_RDWR
)) >= 0){

153 if(
fd
 >= 3){

154 
	`˛o£
(
fd
);

160 
	`gëcmd
(
buf
, (buf)) >= 0){

161 if(
buf
[0] == 'c' && buf[1] == 'd' && buf[2] == ' '){

163 
buf
[
	`°æí
(buf)-1] = 0;

164 if(
	`chdú
(
buf
+3) < 0)

165 
	`Ârötf
(2, "ˇ¬Ÿ cd %s\n", 
buf
+3);

168 if(
	`f‹k1
() == 0)

169 
	`runcmd
(
	`∑r£cmd
(
buf
));

170 
	`waô
(0);

172 
	`exô
(0);

173 
	}
}

176 
	$∑nic
(*
s
)

178 
	`Ârötf
(2, "%s\n", 
s
);

179 
	`exô
(1);

180 
	}
}

183 
	$f‹k1
()

185 
pid
;

187 
pid
 = 
	`f‹k
();

188 if(
pid
 == -1)

189 
	`∑nic
("fork");

190  
pid
;

191 
	}
}

196 
cmd
*

197 
	$execcmd
()

199 
execcmd
 *
cmd
;

201 
cmd
 = 
	`mÆloc
((*cmd));

202 
	`mem£t
(
cmd
, 0, (*cmd));

203 
cmd
->
ty≥
 = 
EXEC
;

204  (
cmd
*)cmd;

205 
	}
}

207 
cmd
*

208 
	$ªdúcmd
(
cmd
 *
subcmd
, *
fûe
, *
efûe
, 
mode
, 
fd
)

210 
ªdúcmd
 *
cmd
;

212 
cmd
 = 
	`mÆloc
((*cmd));

213 
	`mem£t
(
cmd
, 0, (*cmd));

214 
cmd
->
ty≥
 = 
REDIR
;

215 
cmd
->cmd = 
subcmd
;

216 
cmd
->
fûe
 = file;

217 
cmd
->
efûe
 =Éfile;

218 
cmd
->
mode
 = mode;

219 
cmd
->
fd
 = fd;

220  (
cmd
*)cmd;

221 
	}
}

223 
cmd
*

224 
	$pùecmd
(
cmd
 *
À·
, cmd *
right
)

226 
pùecmd
 *
cmd
;

228 
cmd
 = 
	`mÆloc
((*cmd));

229 
	`mem£t
(
cmd
, 0, (*cmd));

230 
cmd
->
ty≥
 = 
PIPE
;

231 
cmd
->
À·
 =Üeft;

232 
cmd
->
right
 =Ñight;

233  (
cmd
*)cmd;

234 
	}
}

236 
cmd
*

237 
	$li°cmd
(
cmd
 *
À·
, cmd *
right
)

239 
li°cmd
 *
cmd
;

241 
cmd
 = 
	`mÆloc
((*cmd));

242 
	`mem£t
(
cmd
, 0, (*cmd));

243 
cmd
->
ty≥
 = 
LIST
;

244 
cmd
->
À·
 =Üeft;

245 
cmd
->
right
 =Ñight;

246  (
cmd
*)cmd;

247 
	}
}

249 
cmd
*

250 
	$backcmd
(
cmd
 *
subcmd
)

252 
backcmd
 *
cmd
;

254 
cmd
 = 
	`mÆloc
((*cmd));

255 
	`mem£t
(
cmd
, 0, (*cmd));

256 
cmd
->
ty≥
 = 
BACK
;

257 
cmd
->cmd = 
subcmd
;

258  (
cmd
*)cmd;

259 
	}
}

263 
	gwhôe•a˚
[] = " \t\r\n\v";

264 
	gsymbﬁs
[] = "<|>&;()";

267 
	$gëtokí
(**
ps
, *
es
, **
q
, **
eq
)

269 *
s
;

270 
ªt
;

272 
s
 = *
ps
;

273 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

274 
s
++;

275 if(
q
)

276 *
q
 = 
s
;

277 
ªt
 = *
s
;

278 *
s
){

287 
s
++;

290 
s
++;

291 if(*
s
 == '>'){

292 
ªt
 = '+';

293 
s
++;

297 
ªt
 = 'a';

298 
s
 < 
es
 && !
	`°rchr
(
whôe•a˚
, *sË&& !°rchr(
symbﬁs
, *s))

299 
s
++;

302 if(
eq
)

303 *
eq
 = 
s
;

305 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

306 
s
++;

307 *
ps
 = 
s
;

308  
ªt
;

309 
	}
}

312 
	$≥ek
(**
ps
, *
es
, *
toks
)

314 *
s
;

316 
s
 = *
ps
;

317 
s
 < 
es
 && 
	`°rchr
(
whôe•a˚
, *s))

318 
s
++;

319 *
ps
 = 
s
;

320  *
s
 && 
	`°rchr
(
toks
, *s);

321 
	}
}

323 
cmd
 *
∑r£löe
(**, *);

324 
cmd
 *
∑r£pùe
(**, *);

325 
cmd
 *
∑r£exec
(**, *);

326 
cmd
 *
nu…îmö©e
(cmd*);

328 
cmd
*

329 
	$∑r£cmd
(*
s
)

331 *
es
;

332 
cmd
 *cmd;

334 
es
 = 
s
 + 
	`°æí
(s);

335 
cmd
 = 
	`∑r£löe
(&
s
, 
es
);

336 
	`≥ek
(&
s
, 
es
, "");

337 if(
s
 !
es
){

338 
	`Ârötf
(2, "À·ovîs: %s\n", 
s
);

339 
	`∑nic
("syntax");

341 
	`nu…îmö©e
(
cmd
);

342  
cmd
;

343 
	}
}

345 
cmd
*

346 
	$∑r£löe
(**
ps
, *
es
)

348 
cmd
 *cmd;

350 
cmd
 = 
	`∑r£pùe
(
ps
, 
es
);

351 
	`≥ek
(
ps
, 
es
, "&")){

352 
	`gëtokí
(
ps
, 
es
, 0, 0);

353 
cmd
 = 
	`backcmd
(cmd);

355 if(
	`≥ek
(
ps
, 
es
, ";")){

356 
	`gëtokí
(
ps
, 
es
, 0, 0);

357 
cmd
 = 
	`li°cmd
(cmd, 
	`∑r£löe
(
ps
, 
es
));

359  
cmd
;

360 
	}
}

362 
cmd
*

363 
	$∑r£pùe
(**
ps
, *
es
)

365 
cmd
 *cmd;

367 
cmd
 = 
	`∑r£exec
(
ps
, 
es
);

368 if(
	`≥ek
(
ps
, 
es
, "|")){

369 
	`gëtokí
(
ps
, 
es
, 0, 0);

370 
cmd
 = 
	`pùecmd
(cmd, 
	`∑r£pùe
(
ps
, 
es
));

372  
cmd
;

373 
	}
}

375 
cmd
*

376 
	$∑r£ªdús
(
cmd
 *cmd, **
ps
, *
es
)

378 
tok
;

379 *
q
, *
eq
;

381 
	`≥ek
(
ps
, 
es
, "<>")){

382 
tok
 = 
	`gëtokí
(
ps
, 
es
, 0, 0);

383 if(
	`gëtokí
(
ps
, 
es
, &
q
, &
eq
) != 'a')

384 
	`∑nic
("missing file forÑedirection");

385 
tok
){

387 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_RDONLY
, 0);

390 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_WRONLY
|
O_CREATE
|
O_TRUNC
, 1);

393 
cmd
 = 
	`ªdúcmd
(cmd, 
q
, 
eq
, 
O_WRONLY
|
O_CREATE
, 1);

397  
cmd
;

398 
	}
}

400 
cmd
*

401 
	$∑r£block
(**
ps
, *
es
)

403 
cmd
 *cmd;

405 if(!
	`≥ek
(
ps
, 
es
, "("))

406 
	`∑nic
("parseblock");

407 
	`gëtokí
(
ps
, 
es
, 0, 0);

408 
cmd
 = 
	`∑r£löe
(
ps
, 
es
);

409 if(!
	`≥ek
(
ps
, 
es
, ")"))

410 
	`∑nic
("syntax - missing )");

411 
	`gëtokí
(
ps
, 
es
, 0, 0);

412 
cmd
 = 
	`∑r£ªdús
(cmd, 
ps
, 
es
);

413  
cmd
;

414 
	}
}

416 
cmd
*

417 
	$∑r£exec
(**
ps
, *
es
)

419 *
q
, *
eq
;

420 
tok
, 
¨gc
;

421 
execcmd
 *
cmd
;

422 
cmd
 *
ªt
;

424 if(
	`≥ek
(
ps
, 
es
, "("))

425  
	`∑r£block
(
ps
, 
es
);

427 
ªt
 = 
	`execcmd
();

428 
cmd
 = (
execcmd
*)
ªt
;

430 
¨gc
 = 0;

431 
ªt
 = 
	`∑r£ªdús
‘ë, 
ps
, 
es
);

432 !
	`≥ek
(
ps
, 
es
, "|)&;")){

433 if((
tok
=
	`gëtokí
(
ps
, 
es
, &
q
, &
eq
)) == 0)

435 if(
tok
 != 'a')

436 
	`∑nic
("syntax");

437 
cmd
->
¨gv
[
¨gc
] = 
q
;

438 
cmd
->
órgv
[
¨gc
] = 
eq
;

439 
¨gc
++;

440 if(
¨gc
 >
MAXARGS
)

441 
	`∑nic
("too manyárgs");

442 
ªt
 = 
	`∑r£ªdús
‘ë, 
ps
, 
es
);

444 
cmd
->
¨gv
[
¨gc
] = 0;

445 
cmd
->
órgv
[
¨gc
] = 0;

446  
ªt
;

447 
	}
}

450 
cmd
*

451 
	$nu…îmö©e
(
cmd
 *cmd)

453 
i
;

454 
backcmd
 *
bcmd
;

455 
execcmd
 *
ecmd
;

456 
li°cmd
 *
lcmd
;

457 
pùecmd
 *
pcmd
;

458 
ªdúcmd
 *
rcmd
;

460 if(
cmd
 == 0)

463 
cmd
->
ty≥
){

464 
EXEC
:

465 
ecmd
 = (
execcmd
*)
cmd
;

466 
i
=0; 
ecmd
->
¨gv
[i]; i++)

467 *
ecmd
->
órgv
[
i
] = 0;

470 
REDIR
:

471 
rcmd
 = (
ªdúcmd
*)
cmd
;

472 
	`nu…îmö©e
(
rcmd
->
cmd
);

473 *
rcmd
->
efûe
 = 0;

476 
PIPE
:

477 
pcmd
 = (
pùecmd
*)
cmd
;

478 
	`nu…îmö©e
(
pcmd
->
À·
);

479 
	`nu…îmö©e
(
pcmd
->
right
);

482 
LIST
:

483 
lcmd
 = (
li°cmd
*)
cmd
;

484 
	`nu…îmö©e
(
lcmd
->
À·
);

485 
	`nu…îmö©e
(
lcmd
->
right
);

488 
BACK
:

489 
bcmd
 = (
backcmd
*)
cmd
;

490 
	`nu…îmö©e
(
bcmd
->
cmd
);

493  
cmd
;

494 
	}
}

	@stressfs.c

10 
	~"kî√l/ty≥s.h
"

11 
	~"kî√l/°©.h
"

12 
	~"u£r/u£r.h
"

13 
	~"kî√l/fs.h
"

14 
	~"kî√l/f˙é.h
"

17 
	$maö
(
¨gc
, *
¨gv
[])

19 
fd
, 
i
;

20 
∑th
[] = "stressfs0";

21 
d©a
[512];

23 
	`¥ötf
("stressfs starting\n");

24 
	`mem£t
(
d©a
, 'a', (data));

26 
i
 = 0; i < 4; i++)

27 if(
	`f‹k
() > 0)

30 
	`¥ötf
("wrôê%d\n", 
i
);

32 
∑th
[8] +
i
;

33 
fd
 = 
	`›í
(
∑th
, 
O_CREATE
 | 
O_RDWR
);

34 
i
 = 0; i < 20; i++)

36 
	`wrôe
(
fd
, 
d©a
, (data));

37 
	`˛o£
(
fd
);

39 
	`¥ötf
("read\n");

41 
fd
 = 
	`›í
(
∑th
, 
O_RDONLY
);

42 
i
 = 0; i < 20; i++)

43 
	`ªad
(
fd
, 
d©a
, (data));

44 
	`˛o£
(
fd
);

46 
	`waô
(0);

48 
	`exô
(0);

49 
	}
}

	@ulib.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"kî√l/f˙é.h
"

4 
	~"u£r/u£r.h
"

10 
	$_maö
()

12 
	`maö
();

13 
	`maö
();

14 
	`exô
(0);

15 
	}
}

18 
	$°r˝y
(*
s
, c⁄° *
t
)

20 *
os
;

22 
os
 = 
s
;

23 (*
s
++ = *
t
++) != 0)

25  
os
;

26 
	}
}

29 
	$°rcmp
(c⁄° *
p
, c⁄° *
q
)

31 *
p
 && *∞=*
q
)

32 
p
++, 
q
++;

33  (
uch¨
)*
p
 - (uch¨)*
q
;

34 
	}
}

36 
uöt


37 
	$°æí
(c⁄° *
s
)

39 
n
;

41 
n
 = 0; 
s
[n];Ç++)

43  
n
;

44 
	}
}

47 
	$mem£t
(*
d°
, 
c
, 
uöt
 
n
)

49 *
cd°
 = (*Ë
d°
;

50 
i
;

51 
i
 = 0; i < 
n
; i++){

52 
cd°
[
i
] = 
c
;

54  
d°
;

55 
	}
}

58 
	$°rchr
(c⁄° *
s
, 
c
)

60 ; *
s
; s++)

61 if(*
s
 =
c
)

62  (*)
s
;

64 
	}
}

67 
	$gës
(*
buf
, 
max
)

69 
i
, 
cc
;

70 
c
;

72 
i
=0; i+1 < 
max
; ){

73 
cc
 = 
	`ªad
(0, &
c
, 1);

74 if(
cc
 < 1)

76 
buf
[
i
++] = 
c
;

77 if(
c
 == '\n' || c == '\r')

80 
buf
[
i
] = '\0';

81  
buf
;

82 
	}
}

85 
	$°©
(c⁄° *
n
, 
°©
 *
°
)

87 
fd
;

88 
r
;

90 
fd
 = 
	`›í
(
n
, 
O_RDONLY
);

91 if(
fd
 < 0)

93 
r
 = 
	`f°©
(
fd
, 
°
);

94 
	`˛o£
(
fd
);

95  
r
;

96 
	}
}

99 
	$©oi
(c⁄° *
s
)

101 
n
;

103 
n
 = 0;

104 '0' <*
s
 && *s <= '9')

105 
n
 =Ç*10 + *
s
++ - '0';

106  
n
;

107 
	}
}

110 
	$memmove
(*
vd°
, c⁄° *
v§c
, 
n
)

112 *
d°
;

113 c⁄° *
§c
;

115 
d°
 = 
vd°
;

116 
§c
 = 
v§c
;

117 i‡(
§c
 > 
d°
) {

118 
n
-- > 0)

119 *
d°
++ = *
§c
++;

121 
d°
 +
n
;

122 
§c
 +
n
;

123 
n
-- > 0)

124 *--
d°
 = *--
§c
;

126  
vd°
;

127 
	}
}

130 
	$memcmp
(c⁄° *
s1
, c⁄° *
s2
, 
uöt
 
n
)

132 c⁄° *
p1
 = 
s1
, *
p2
 = 
s2
;

133 
n
-- > 0) {

134 i‡(*
p1
 !*
p2
) {

135  *
p1
 - *
p2
;

137 
p1
++;

138 
p2
++;

141 
	}
}

144 
	$mem˝y
(*
d°
, c⁄° *
§c
, 
uöt
 
n
)

146  
	`memmove
(
d°
, 
§c
, 
n
);

147 
	}
}

	@umalloc.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

4 
	~"kî√l/∑øm.h
"

9 
	tAlign
;

11 
	uhódî
 {

13 
hódî
 *
	m±r
;

14 
uöt
 
	msize
;

15 } 
	ms
;

16 
Align
 
	mx
;

19 
hódî
 
	tHódî
;

21 
Hódî
 
	gba£
;

22 
Hódî
 *
	g‰ìp
;

25 
	$‰ì
(*
≠
)

27 
Hódî
 *
bp
, *
p
;

29 
bp
 = (
Hódî
*)
≠
 - 1;

30 
p
 = 
‰ìp
; !(
bp
 >Ö && b∞<Ö->
s
.
±r
);Ö =Ö->s.ptr)

31 if(
p
 >p->
s
.
±r
 && (
bp
 >Ö || bp <Ö->s.ptr))

33 if(
bp
 + bp->
s
.
size
 =
p
->s.
±r
){

34 
bp
->
s
.
size
 +
p
->s.
±r
->s.size;

35 
bp
->
s
.
±r
 = 
p
->s.ptr->s.ptr;

37 
bp
->
s
.
±r
 = 
p
->s.ptr;

38 if(
p
 +Ö->
s
.
size
 =
bp
){

39 
p
->
s
.
size
 +
bp
->s.size;

40 
p
->
s
.
±r
 = 
bp
->s.ptr;

42 
p
->
s
.
±r
 = 
bp
;

43 
‰ìp
 = 
p
;

44 
	}
}

46 
Hódî
*

47 
	$m‹ec‹e
(
uöt
 
nu
)

49 *
p
;

50 
Hódî
 *
hp
;

52 if(
nu
 < 4096)

53 
nu
 = 4096;

54 
p
 = 
	`sbrk
(
nu
 * (
Hódî
));

55 if(
p
 == (*)-1)

57 
hp
 = (
Hódî
*)
p
;

58 
hp
->
s
.
size
 = 
nu
;

59 
	`‰ì
((*)(
hp
 + 1));

60  
‰ìp
;

61 
	}
}

64 
	$mÆloc
(
uöt
 
nbyãs
)

66 
Hódî
 *
p
, *
¥evp
;

67 
uöt
 
nunôs
;

69 
nunôs
 = (
nbyãs
 + (
Hódî
) - 1)/(Header) + 1;

70 if((
¥evp
 = 
‰ìp
) == 0){

71 
ba£
.
s
.
±r
 = 
‰ìp
 = 
¥evp
 = &base;

72 
ba£
.
s
.
size
 = 0;

74 
p
 = 
¥evp
->
s
.
±r
; ;Örevp =Ö,Ö =Ö->s.ptr){

75 if(
p
->
s
.
size
 >
nunôs
){

76 if(
p
->
s
.
size
 =
nunôs
)

77 
¥evp
->
s
.
±r
 = 
p
->s.ptr;

79 
p
->
s
.
size
 -
nunôs
;

80 
p
 +p->
s
.
size
;

81 
p
->
s
.
size
 = 
nunôs
;

83 
‰ìp
 = 
¥evp
;

84  (*)(
p
 + 1);

86 if(
p
 =
‰ìp
)

87 if((
p
 = 
	`m‹ec‹e
(
nunôs
)) == 0)

90 
	}
}

	@usertests.c

1 
	~"kî√l/∑øm.h
"

2 
	~"kî√l/ty≥s.h
"

3 
	~"kî√l/°©.h
"

4 
	~"u£r/u£r.h
"

5 
	~"kî√l/fs.h
"

6 
	~"kî√l/f˙é.h
"

7 
	~"kî√l/sysˇŒ.h
"

8 
	~"kî√l/memœyout.h
"

9 
	~"kî√l/riscv.h
"

20 
	#BUFSZ
 ((
MAXOPBLOCKS
+2)*
BSIZE
)

	)

22 
	gbuf
[
BUFSZ
];

33 
	$c›yö
(*
s
)

35 
uöt64
 
addrs
[] = { 0x80000000LL, 0xffffffffffffffff };

37 
ai
 = 0;ái < 2;ái++){

38 
uöt64
 
addr
 = 
addrs
[
ai
];

40 
fd
 = 
	`›í
("c›yö1", 
O_CREATE
|
O_WRONLY
);

41 if(
fd
 < 0){

42 
	`¥ötf
("open(copyin1) failed\n");

43 
	`exô
(1);

45 
n
 = 
	`wrôe
(
fd
, (*)
addr
, 8192);

46 if(
n
 >= 0){

47 
	`¥ötf
("wrôe(fd, %p, 8192Ëªtu∫ed %d,ÇŸ -1\n", 
addr
, 
n
);

48 
	`exô
(1);

50 
	`˛o£
(
fd
);

51 
	`u∆ök
("copyin1");

53 
n
 = 
	`wrôe
(1, (*)
addr
, 8192);

54 if(
n
 > 0){

55 
	`¥ötf
("wrôe(1, %p, 8192Ëªtu∫ed %d,ÇŸ -1 o∏0\n", 
addr
, 
n
);

56 
	`exô
(1);

59 
fds
[2];

60 if(
	`pùe
(
fds
) < 0){

61 
	`¥ötf
("pipe() failed\n");

62 
	`exô
(1);

64 
n
 = 
	`wrôe
(
fds
[1], (*)
addr
, 8192);

65 if(
n
 > 0){

66 
	`¥ötf
("wrôe’ùe, %p, 8192Ëªtu∫ed %d,ÇŸ -1 o∏0\n", 
addr
, 
n
);

67 
	`exô
(1);

69 
	`˛o£
(
fds
[0]);

70 
	`˛o£
(
fds
[1]);

72 
	}
}

77 
	$c›yout
(*
s
)

79 
uöt64
 
addrs
[] = { 0x80000000LL, 0xffffffffffffffff };

81 
ai
 = 0;ái < 2;ái++){

82 
uöt64
 
addr
 = 
addrs
[
ai
];

84 
fd
 = 
	`›í
("README", 0);

85 if(
fd
 < 0){

86 
	`¥ötf
("open(README) failed\n");

87 
	`exô
(1);

89 
n
 = 
	`ªad
(
fd
, (*)
addr
, 8192);

90 if(
n
 > 0){

91 
	`¥ötf
("ªad(fd, %p, 8192Ëªtu∫ed %d,ÇŸ -1 o∏0\n", 
addr
, 
n
);

92 
	`exô
(1);

94 
	`˛o£
(
fd
);

96 
fds
[2];

97 if(
	`pùe
(
fds
) < 0){

98 
	`¥ötf
("pipe() failed\n");

99 
	`exô
(1);

101 
n
 = 
	`wrôe
(
fds
[1], "x", 1);

102 if(
n
 != 1){

103 
	`¥ötf
("pipe write failed\n");

104 
	`exô
(1);

106 
n
 = 
	`ªad
(
fds
[0], (*)
addr
, 8192);

107 if(
n
 > 0){

108 
	`¥ötf
("ªad’ùe, %p, 8192Ëªtu∫ed %d,ÇŸ -1 o∏0\n", 
addr
, 
n
);

109 
	`exô
(1);

111 
	`˛o£
(
fds
[0]);

112 
	`˛o£
(
fds
[1]);

114 
	}
}

118 
	$c›yö°r1
(*
s
)

120 
uöt64
 
addrs
[] = { 0x80000000LL, 0xffffffffffffffff };

122 
ai
 = 0;ái < 2;ái++){

123 
uöt64
 
addr
 = 
addrs
[
ai
];

125 
fd
 = 
	`›í
((*)
addr
, 
O_CREATE
|
O_WRONLY
);

126 if(
fd
 >= 0){

127 
	`¥ötf
("›í(%pËªtu∫ed %d,ÇŸ -1\n", 
addr
, 
fd
);

128 
	`exô
(1);

131 
	}
}

137 
	$c›yö°r2
(*
s
)

139 
b
[
MAXPATH
+1];

141 
i
 = 0; i < 
MAXPATH
; i++)

142 
b
[
i
] = 'x';

143 
b
[
MAXPATH
] = '\0';

145 
ªt
 = 
	`u∆ök
(
b
);

146 if(
ªt
 != -1){

147 
	`¥ötf
("u∆ök(%sËªtu∫ed %d,ÇŸ -1\n", 
b
, 
ªt
);

148 
	`exô
(1);

151 
fd
 = 
	`›í
(
b
, 
O_CREATE
 | 
O_WRONLY
);

152 if(
fd
 != -1){

153 
	`¥ötf
("›í(%sËªtu∫ed %d,ÇŸ -1\n", 
b
, 
fd
);

154 
	`exô
(1);

157 
ªt
 = 
	`lök
(
b
, b);

158 if(
ªt
 != -1){

159 
	`¥ötf
("lök(%s, %sËªtu∫ed %d,ÇŸ -1\n", 
b
, b, 
ªt
);

160 
	`exô
(1);

163 *
¨gs
[] = { "xx", 0 };

164 
ªt
 = 
	`exec
(
b
, 
¨gs
);

165 if(
ªt
 != -1){

166 
	`¥ötf
("exec(%sËªtu∫ed %d,ÇŸ -1\n", 
b
, 
fd
);

167 
	`exô
(1);

170 
pid
 = 
	`f‹k
();

171 if(
pid
 < 0){

172 
	`¥ötf
("fork failed\n");

173 
	`exô
(1);

175 if(
pid
 == 0){

176 
big
[
PGSIZE
+1];

177 
i
 = 0; i < 
PGSIZE
; i++)

178 
big
[
i
] = 'x';

179 
big
[
PGSIZE
] = '\0';

180 *
¨gs2
[] = { 
big
, big, big, 0 };

181 
ªt
 = 
	`exec
("echo", 
¨gs2
);

182 if(
ªt
 != -1){

183 
	`¥ötf
("exec”cho, BIGËªtu∫ed %d,ÇŸ -1\n", 
fd
);

184 
	`exô
(1);

186 
	`exô
(747);

189 
°
 = 0;

190 
	`waô
(&
°
);

191 if(
°
 != 747){

192 
	`¥ötf
("exec(echo, BIG) succeeded, should have failed\n");

193 
	`exô
(1);

195 
	}
}

199 
	$c›yö°r3
(*
s
)

201 
	`sbrk
(8192);

202 
uöt64
 
t›
 = (uöt64Ë
	`sbrk
(0);

203 if((
t›
 % 
PGSIZE
) != 0){

204 
	`sbrk
(
PGSIZE
 - (
t›
 % PGSIZE));

206 
t›
 = (
uöt64
Ë
	`sbrk
(0);

207 if(
t›
 % 
PGSIZE
){

208 
	`¥ötf
("oops\n");

209 
	`exô
(1);

212 *
b
 = (*Ë(
t›
 - 1);

213 *
b
 = 'x';

215 
ªt
 = 
	`u∆ök
(
b
);

216 if(
ªt
 != -1){

217 
	`¥ötf
("u∆ök(%sËªtu∫ed %d,ÇŸ -1\n", 
b
, 
ªt
);

218 
	`exô
(1);

221 
fd
 = 
	`›í
(
b
, 
O_CREATE
 | 
O_WRONLY
);

222 if(
fd
 != -1){

223 
	`¥ötf
("›í(%sËªtu∫ed %d,ÇŸ -1\n", 
b
, 
fd
);

224 
	`exô
(1);

227 
ªt
 = 
	`lök
(
b
, b);

228 if(
ªt
 != -1){

229 
	`¥ötf
("lök(%s, %sËªtu∫ed %d,ÇŸ -1\n", 
b
, b, 
ªt
);

230 
	`exô
(1);

233 *
¨gs
[] = { "xx", 0 };

234 
ªt
 = 
	`exec
(
b
, 
¨gs
);

235 if(
ªt
 != -1){

236 
	`¥ötf
("exec(%sËªtu∫ed %d,ÇŸ -1\n", 
b
, 
fd
);

237 
	`exô
(1);

239 
	}
}

244 
	$rwsbrk
()

246 
fd
, 
n
;

248 
uöt64
 
a
 = (uöt64Ë
	`sbrk
(8192);

250 if(
a
 == 0xffffffffffffffffLL) {

251 
	`¥ötf
("sbrk(rwsbrk) failed\n");

252 
	`exô
(1);

255 i‡((
uöt64
Ë
	`sbrk
(-8192) == 0xffffffffffffffffLL) {

256 
	`¥ötf
("sbrk(rwsbrk) shrink failed\n");

257 
	`exô
(1);

260 
fd
 = 
	`›í
("rwsbrk", 
O_CREATE
|
O_WRONLY
);

261 if(
fd
 < 0){

262 
	`¥ötf
("open(rwsbrk) failed\n");

263 
	`exô
(1);

265 
n
 = 
	`wrôe
(
fd
, (*)(
a
+4096), 1024);

266 if(
n
 >= 0){

267 
	`¥ötf
("wrôe(fd, %p, 1024Ëªtu∫ed %d,ÇŸ -1\n", 
a
+4096, 
n
);

268 
	`exô
(1);

270 
	`˛o£
(
fd
);

271 
	`u∆ök
("rwsbrk");

273 
fd
 = 
	`›í
("README", 
O_RDONLY
);

274 if(
fd
 < 0){

275 
	`¥ötf
("open(rwsbrk) failed\n");

276 
	`exô
(1);

278 
n
 = 
	`ªad
(
fd
, (*)(
a
+4096), 10);

279 if(
n
 >= 0){

280 
	`¥ötf
("ªad(fd, %p, 10Ëªtu∫ed %d,ÇŸ -1\n", 
a
+4096, 
n
);

281 
	`exô
(1);

283 
	`˛o£
(
fd
);

285 
	`exô
(0);

286 
	}
}

290 
	$åunˇã1
(*
s
)

292 
buf
[32];

294 
	`u∆ök
("truncfile");

295 
fd1
 = 
	`›í
("åuncfûe", 
O_CREATE
|
O_WRONLY
|
O_TRUNC
);

296 
	`wrôe
(
fd1
, "abcd", 4);

297 
	`˛o£
(
fd1
);

299 
fd2
 = 
	`›í
("åuncfûe", 
O_RDONLY
);

300 
n
 = 
	`ªad
(
fd2
, 
buf
, (buf));

301 if(
n
 != 4){

302 
	`¥ötf
("%s:Ñód %d byãs, w™ãd 4\n", 
s
, 
n
);

303 
	`exô
(1);

306 
fd1
 = 
	`›í
("åuncfûe", 
O_WRONLY
|
O_TRUNC
);

308 
fd3
 = 
	`›í
("åuncfûe", 
O_RDONLY
);

309 
n
 = 
	`ªad
(
fd3
, 
buf
, (buf));

310 if(
n
 != 0){

311 
	`¥ötf
("Ø®fd3=%d\n", 
fd3
);

312 
	`¥ötf
("%s:Ñód %d byãs, w™ãd 0\n", 
s
, 
n
);

313 
	`exô
(1);

316 
n
 = 
	`ªad
(
fd2
, 
buf
, (buf));

317 if(
n
 != 0){

318 
	`¥ötf
("bbb fd2=%d\n", 
fd2
);

319 
	`¥ötf
("%s:Ñód %d byãs, w™ãd 0\n", 
s
, 
n
);

320 
	`exô
(1);

323 
	`wrôe
(
fd1
, "abcdef", 6);

325 
n
 = 
	`ªad
(
fd3
, 
buf
, (buf));

326 if(
n
 != 6){

327 
	`¥ötf
("%s:Ñód %d byãs, w™ãd 6\n", 
s
, 
n
);

328 
	`exô
(1);

331 
n
 = 
	`ªad
(
fd2
, 
buf
, (buf));

332 if(
n
 != 2){

333 
	`¥ötf
("%s:Ñód %d byãs, w™ãd 2\n", 
s
, 
n
);

334 
	`exô
(1);

337 
	`u∆ök
("truncfile");

339 
	`˛o£
(
fd1
);

340 
	`˛o£
(
fd2
);

341 
	`˛o£
(
fd3
);

342 
	}
}

349 
	$åunˇã2
(*
s
)

351 
	`u∆ök
("truncfile");

353 
fd1
 = 
	`›í
("åuncfûe", 
O_CREATE
|
O_TRUNC
|
O_WRONLY
);

354 
	`wrôe
(
fd1
, "abcd", 4);

356 
fd2
 = 
	`›í
("åuncfûe", 
O_TRUNC
|
O_WRONLY
);

358 
n
 = 
	`wrôe
(
fd1
, "x", 1);

359 if(
n
 != -1){

360 
	`¥ötf
("%s: wrôêªtu∫ed %d,Éx≥˘ed -1\n", 
s
, 
n
);

361 
	`exô
(1);

364 
	`u∆ök
("truncfile");

365 
	`˛o£
(
fd1
);

366 
	`˛o£
(
fd2
);

367 
	}
}

370 
	$åunˇã3
(*
s
)

372 
pid
, 
x°©us
;

374 
	`˛o£
(
	`›í
("åuncfûe", 
O_CREATE
|
O_TRUNC
|
O_WRONLY
));

376 
pid
 = 
	`f‹k
();

377 if(
pid
 < 0){

378 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

379 
	`exô
(1);

382 if(
pid
 == 0){

383 
i
 = 0; i < 100; i++){

384 
buf
[32];

385 
fd
 = 
	`›í
("åuncfûe", 
O_WRONLY
);

386 if(
fd
 < 0){

387 
	`¥ötf
("%s: o≥¿Áûed\n", 
s
);

388 
	`exô
(1);

390 
n
 = 
	`wrôe
(
fd
, "1234567890", 10);

391 if(
n
 != 10){

392 
	`¥ötf
("%s: wrôêgŸ %d,Éx≥˘ed 10\n", 
s
, 
n
);

393 
	`exô
(1);

395 
	`˛o£
(
fd
);

396 
fd
 = 
	`›í
("åuncfûe", 
O_RDONLY
);

397 
	`ªad
(
fd
, 
buf
, (buf));

398 
	`˛o£
(
fd
);

400 
	`exô
(0);

403 
i
 = 0; i < 150; i++){

404 
fd
 = 
	`›í
("åuncfûe", 
O_CREATE
|
O_WRONLY
|
O_TRUNC
);

405 if(
fd
 < 0){

406 
	`¥ötf
("%s: o≥¿Áûed\n", 
s
);

407 
	`exô
(1);

409 
n
 = 
	`wrôe
(
fd
, "xxx", 3);

410 if(
n
 != 3){

411 
	`¥ötf
("%s: wrôêgŸ %d,Éx≥˘ed 3\n", 
s
, 
n
);

412 
	`exô
(1);

414 
	`˛o£
(
fd
);

417 
	`waô
(&
x°©us
);

418 
	`u∆ök
("truncfile");

419 
	`exô
(
x°©us
);

420 
	}
}

425 
	$ùuâe°
(*
s
)

427 if(
	`mkdú
("iputdir") < 0){

428 
	`¥ötf
("%s: mkdú faûed\n", 
s
);

429 
	`exô
(1);

431 if(
	`chdú
("iputdir") < 0){

432 
	`¥ötf
("%s: chdú iputdú faûed\n", 
s
);

433 
	`exô
(1);

435 if(
	`u∆ök
("../iputdir") < 0){

436 
	`¥ötf
("%s: u∆ök ../ùutdú faûed\n", 
s
);

437 
	`exô
(1);

439 if(
	`chdú
("/") < 0){

440 
	`¥ötf
("%s: chdú / faûed\n", 
s
);

441 
	`exô
(1);

443 
	}
}

447 
	$exôùuâe°
(*
s
)

449 
pid
, 
x°©us
;

451 
pid
 = 
	`f‹k
();

452 if(
pid
 < 0){

453 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

454 
	`exô
(1);

456 if(
pid
 == 0){

457 if(
	`mkdú
("iputdir") < 0){

458 
	`¥ötf
("%s: mkdú faûed\n", 
s
);

459 
	`exô
(1);

461 if(
	`chdú
("iputdir") < 0){

462 
	`¥ötf
("%s: chûd chdú faûed\n", 
s
);

463 
	`exô
(1);

465 if(
	`u∆ök
("../iputdir") < 0){

466 
	`¥ötf
("%s: u∆ök ../ùutdú faûed\n", 
s
);

467 
	`exô
(1);

469 
	`exô
(0);

471 
	`waô
(&
x°©us
);

472 
	`exô
(
x°©us
);

473 
	}
}

487 
	$›íùuâe°
(*
s
)

489 
pid
, 
x°©us
;

491 if(
	`mkdú
("oidir") < 0){

492 
	`¥ötf
("%s: mkdú oidú faûed\n", 
s
);

493 
	`exô
(1);

495 
pid
 = 
	`f‹k
();

496 if(
pid
 < 0){

497 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

498 
	`exô
(1);

500 if(
pid
 == 0){

501 
fd
 = 
	`›í
("oidú", 
O_RDWR
);

502 if(
fd
 >= 0){

503 
	`¥ötf
("%s: o≥¿dúe˘‹y f‹ wrôêsuc˚eded\n", 
s
);

504 
	`exô
(1);

506 
	`exô
(0);

508 
	`¶ìp
(1);

509 if(
	`u∆ök
("oidir") != 0){

510 
	`¥ötf
("%s: u∆ök faûed\n", 
s
);

511 
	`exô
(1);

513 
	`waô
(&
x°©us
);

514 
	`exô
(
x°©us
);

515 
	}
}

520 
	$›íã°
(*
s
)

522 
fd
;

524 
fd
 = 
	`›í
("echo", 0);

525 if(
fd
 < 0){

526 
	`¥ötf
("%s: o≥¿echÿÁûed!\n", 
s
);

527 
	`exô
(1);

529 
	`˛o£
(
fd
);

530 
fd
 = 
	`›í
("doesnotexist", 0);

531 if(
fd
 >= 0){

532 
	`¥ötf
("%s: o≥¿d€¢Ÿexi° suc˚eded!\n", 
s
);

533 
	`exô
(1);

535 
	}
}

538 
	$wrôëe°
(*
s
)

540 
fd
;

541 
i
;

542 íum { 
N
=100, 
SZ
=10 };

544 
fd
 = 
	`›í
("smÆl", 
O_CREATE
|
O_RDWR
);

545 if(
fd
 < 0){

546 
	`¥ötf
("%s:Éº‹: cª© smÆ»Áûed!\n", 
s
);

547 
	`exô
(1);

549 
i
 = 0; i < 
N
; i++){

550 if(
	`wrôe
(
fd
, "ØØØØØ", 
SZ
) != SZ){

551 
	`¥ötf
("%s:Éº‹: wrôêØ %dÇew fûêÁûed\n", 
s
, 
i
);

552 
	`exô
(1);

554 if(
	`wrôe
(
fd
, "bbbbbbbbbb", 
SZ
) != SZ){

555 
	`¥ötf
("%s:Éº‹: wrôêbb %dÇew fûêÁûed\n", 
s
, 
i
);

556 
	`exô
(1);

559 
	`˛o£
(
fd
);

560 
fd
 = 
	`›í
("smÆl", 
O_RDONLY
);

561 if(
fd
 < 0){

562 
	`¥ötf
("%s:Éº‹: o≥¿smÆ»Áûed!\n", 
s
);

563 
	`exô
(1);

565 
i
 = 
	`ªad
(
fd
, 
buf
, 
N
*
SZ
*2);

566 if(
i
 !
N
*
SZ
*2){

567 
	`¥ötf
("%s:Ñód faûed\n", 
s
);

568 
	`exô
(1);

570 
	`˛o£
(
fd
);

572 if(
	`u∆ök
("small") < 0){

573 
	`¥ötf
("%s: u∆ök smÆ»Áûed\n", 
s
);

574 
	`exô
(1);

576 
	}
}

579 
	$wrôebig
(*
s
)

581 
i
, 
fd
, 
n
;

583 
fd
 = 
	`›í
("big", 
O_CREATE
|
O_RDWR
);

584 if(
fd
 < 0){

585 
	`¥ötf
("%s:Éº‹: cª© big faûed!\n", 
s
);

586 
	`exô
(1);

589 
i
 = 0; i < 
MAXFILE
; i++){

590 ((*)
buf
)[0] = 
i
;

591 if(
	`wrôe
(
fd
, 
buf
, 
BSIZE
) != BSIZE){

592 
	`¥ötf
("%s:Éº‹: wrôêbig fûêÁûed\n", 
s
, 
i
);

593 
	`exô
(1);

597 
	`˛o£
(
fd
);

599 
fd
 = 
	`›í
("big", 
O_RDONLY
);

600 if(
fd
 < 0){

601 
	`¥ötf
("%s:Éº‹: o≥¿big faûed!\n", 
s
);

602 
	`exô
(1);

605 
n
 = 0;

607 
i
 = 
	`ªad
(
fd
, 
buf
, 
BSIZE
);

608 if(
i
 == 0){

609 if(
n
 =
MAXFILE
 - 1){

610 
	`¥ötf
("%s:Ñód o∆y %d block†‰om big", 
s
, 
n
);

611 
	`exô
(1);

614 } if(
i
 !
BSIZE
){

615 
	`¥ötf
("%s:Ñód faûed %d\n", 
s
, 
i
);

616 
	`exô
(1);

618 if(((*)
buf
)[0] !
n
){

619 
	`¥ötf
("%s:Ñód c⁄ã¡ o‡block %d i†%d\n", 
s
,

620 
n
, ((*)
buf
)[0]);

621 
	`exô
(1);

623 
n
++;

625 
	`˛o£
(
fd
);

626 if(
	`u∆ök
("big") < 0){

627 
	`¥ötf
("%s: u∆ök big faûed\n", 
s
);

628 
	`exô
(1);

630 
	}
}

634 
	$¸óãã°
(*
s
)

636 
i
, 
fd
;

637 íum { 
N
=52 };

639 
«me
[3];

640 
«me
[0] = 'a';

641 
«me
[2] = '\0';

642 
i
 = 0; i < 
N
; i++){

643 
«me
[1] = '0' + 
i
;

644 
fd
 = 
	`›í
(
«me
, 
O_CREATE
|
O_RDWR
);

645 
	`˛o£
(
fd
);

647 
«me
[0] = 'a';

648 
«me
[2] = '\0';

649 
i
 = 0; i < 
N
; i++){

650 
«me
[1] = '0' + 
i
;

651 
	`u∆ök
(
«me
);

653 
	}
}

655 
	$dúã°
(*
s
)

657 if(
	`mkdú
("dir0") < 0){

658 
	`¥ötf
("%s: mkdú faûed\n", 
s
);

659 
	`exô
(1);

662 if(
	`chdú
("dir0") < 0){

663 
	`¥ötf
("%s: chdú dú0 faûed\n", 
s
);

664 
	`exô
(1);

667 if(
	`chdú
("..") < 0){

668 
	`¥ötf
("%s: chdú .. faûed\n", 
s
);

669 
	`exô
(1);

672 if(
	`u∆ök
("dir0") < 0){

673 
	`¥ötf
("%s: u∆ök dú0 faûed\n", 
s
);

674 
	`exô
(1);

676 
	}
}

679 
	$exe˘e°
(*
s
)

681 
fd
, 
x°©us
, 
pid
;

682 *
echﬂrgv
[] = { "echo", "OK", 0 };

683 
buf
[3];

685 
	`u∆ök
("echo-ok");

686 
pid
 = 
	`f‹k
();

687 if(
pid
 < 0) {

688 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

689 
	`exô
(1);

691 if(
pid
 == 0) {

692 
	`˛o£
(1);

693 
fd
 = 
	`›í
("echo-ok", 
O_CREATE
|
O_WRONLY
);

694 if(
fd
 < 0) {

695 
	`¥ötf
("%s: cª©êÁûed\n", 
s
);

696 
	`exô
(1);

698 if(
fd
 != 1) {

699 
	`¥ötf
("%s: wr⁄g fd\n", 
s
);

700 
	`exô
(1);

702 if(
	`exec
("echo", 
echﬂrgv
) < 0){

703 
	`¥ötf
("%s:Éxe¯echÿÁûed\n", 
s
);

704 
	`exô
(1);

708 i‡(
	`waô
(&
x°©us
Ë!
pid
) {

709 
	`¥ötf
("%s: waô faûed!\n", 
s
);

711 if(
x°©us
 != 0)

712 
	`exô
(
x°©us
);

714 
fd
 = 
	`›í
("echo-ok", 
O_RDONLY
);

715 if(
fd
 < 0) {

716 
	`¥ötf
("%s: o≥¿Áûed\n", 
s
);

717 
	`exô
(1);

719 i‡(
	`ªad
(
fd
, 
buf
, 2) != 2) {

720 
	`¥ötf
("%s:Ñód faûed\n", 
s
);

721 
	`exô
(1);

723 
	`u∆ök
("echo-ok");

724 if(
buf
[0] == 'O' && buf[1] == 'K')

725 
	`exô
(0);

727 
	`¥ötf
("%s: wr⁄g ouçut\n", 
s
);

728 
	`exô
(1);

731 
	}
}

736 
	$pùe1
(*
s
)

738 
fds
[2], 
pid
, 
x°©us
;

739 
£q
, 
i
, 
n
, 
cc
, 
tŸÆ
;

740 íum { 
N
=5, 
SZ
=1033 };

742 if(
	`pùe
(
fds
) != 0){

743 
	`¥ötf
("%s:Öùe(ËÁûed\n", 
s
);

744 
	`exô
(1);

746 
pid
 = 
	`f‹k
();

747 
£q
 = 0;

748 if(
pid
 == 0){

749 
	`˛o£
(
fds
[0]);

750 
n
 = 0;Ç < 
N
;Ç++){

751 
i
 = 0; i < 
SZ
; i++)

752 
buf
[
i
] = 
£q
++;

753 if(
	`wrôe
(
fds
[1], 
buf
, 
SZ
) != SZ){

754 
	`¥ötf
("%s:Öùe1 o›†1\n", 
s
);

755 
	`exô
(1);

758 
	`exô
(0);

759 } if(
pid
 > 0){

760 
	`˛o£
(
fds
[1]);

761 
tŸÆ
 = 0;

762 
cc
 = 1;

763 (
n
 = 
	`ªad
(
fds
[0], 
buf
, 
cc
)) > 0){

764 
i
 = 0; i < 
n
; i++){

765 if((
buf
[
i
] & 0xffË!(
£q
++ & 0xff)){

766 
	`¥ötf
("%s:Öùe1 o›†2\n", 
s
);

770 
tŸÆ
 +
n
;

771 
cc
 = cc * 2;

772 if(
cc
 > (
buf
))

773 
cc
 = (
buf
);

775 if(
tŸÆ
 !
N
 * 
SZ
){

776 
	`¥ötf
("%s:Öùe1 o›†3ÅŸÆ %d\n", 
tŸÆ
);

777 
	`exô
(1);

779 
	`˛o£
(
fds
[0]);

780 
	`waô
(&
x°©us
);

781 
	`exô
(
x°©us
);

783 
	`¥ötf
("%s: f‹k(ËÁûed\n", 
s
);

784 
	`exô
(1);

786 
	}
}

791 
	$kûl°©us
(*
s
)

793 
x°
;

795 
i
 = 0; i < 100; i++){

796 
pid1
 = 
	`f‹k
();

797 if(
pid1
 < 0){

798 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

799 
	`exô
(1);

801 if(
pid1
 == 0){

803 
	`gëpid
();

805 
	`exô
(0);

807 
	`¶ìp
(1);

808 
	`kûl
(
pid1
);

809 
	`waô
(&
x°
);

810 if(
x°
 != -1) {

811 
	`¥ötf
("%s: sètu†should bê-1\n", 
s
);

812 
	`exô
(1);

815 
	`exô
(0);

816 
	}
}

820 
	$¥ìm±
(*
s
)

822 
pid1
, 
pid2
, 
pid3
;

823 
pfds
[2];

825 
pid1
 = 
	`f‹k
();

826 if(
pid1
 < 0) {

827 
	`¥ötf
("%s: f‹k faûed", 
s
);

828 
	`exô
(1);

830 if(
pid1
 == 0)

834 
pid2
 = 
	`f‹k
();

835 if(
pid2
 < 0) {

836 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

837 
	`exô
(1);

839 if(
pid2
 == 0)

843 
	`pùe
(
pfds
);

844 
pid3
 = 
	`f‹k
();

845 if(
pid3
 < 0) {

846 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

847 
	`exô
(1);

849 if(
pid3
 == 0){

850 
	`˛o£
(
pfds
[0]);

851 if(
	`wrôe
(
pfds
[1], "x", 1) != 1)

852 
	`¥ötf
("%s:Öªem± wrôêîr‹", 
s
);

853 
	`˛o£
(
pfds
[1]);

858 
	`˛o£
(
pfds
[1]);

859 if(
	`ªad
(
pfds
[0], 
buf
, (buf)) != 1){

860 
	`¥ötf
("%s:Öªem±ÑódÉº‹", 
s
);

863 
	`˛o£
(
pfds
[0]);

864 
	`¥ötf
("kill... ");

865 
	`kûl
(
pid1
);

866 
	`kûl
(
pid2
);

867 
	`kûl
(
pid3
);

868 
	`¥ötf
("wait... ");

869 
	`waô
(0);

870 
	`waô
(0);

871 
	`waô
(0);

872 
	}
}

876 
	$exôwaô
(*
s
)

878 
i
, 
pid
;

880 
i
 = 0; i < 100; i++){

881 
pid
 = 
	`f‹k
();

882 if(
pid
 < 0){

883 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

884 
	`exô
(1);

886 if(
pid
){

887 
x°©e
;

888 if(
	`waô
(&
x°©e
Ë!
pid
){

889 
	`¥ötf
("%s: waô wr⁄gÖid\n", 
s
);

890 
	`exô
(1);

892 if(
i
 !
x°©e
) {

893 
	`¥ötf
("%s: waô wr⁄gÉxô sètus\n", 
s
);

894 
	`exô
(1);

897 
	`exô
(
i
);

900 
	}
}

906 
	$ª∑ª¡
(*
s
)

908 
ma°î_pid
 = 
	`gëpid
();

909 
i
 = 0; i < 200; i++){

910 
pid
 = 
	`f‹k
();

911 if(
pid
 < 0){

912 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

913 
	`exô
(1);

915 if(
pid
){

916 if(
	`waô
(0Ë!
pid
){

917 
	`¥ötf
("%s: waô wr⁄gÖid\n", 
s
);

918 
	`exô
(1);

921 
pid2
 = 
	`f‹k
();

922 if(
pid2
 < 0){

923 
	`kûl
(
ma°î_pid
);

924 
	`exô
(1);

926 
	`exô
(0);

929 
	`exô
(0);

930 
	}
}

934 
	$twochûdªn
(*
s
)

936 
i
 = 0; i < 1000; i++){

937 
pid1
 = 
	`f‹k
();

938 if(
pid1
 < 0){

939 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

940 
	`exô
(1);

942 if(
pid1
 == 0){

943 
	`exô
(0);

945 
pid2
 = 
	`f‹k
();

946 if(
pid2
 < 0){

947 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

948 
	`exô
(1);

950 if(
pid2
 == 0){

951 
	`exô
(0);

953 
	`waô
(0);

954 
	`waô
(0);

958 
	}
}

962 
	$f‹kf‹k
(*
s
)

964 íum { 
N
=2 };

966 
i
 = 0; i < 
N
; i++){

967 
pid
 = 
	`f‹k
();

968 if(
pid
 < 0){

969 
	`¥ötf
("%s: f‹k faûed", 
s
);

970 
	`exô
(1);

972 if(
pid
 == 0){

973 
j
 = 0; j < 200; j++){

974 
pid1
 = 
	`f‹k
();

975 if(
pid1
 < 0){

976 
	`exô
(1);

978 if(
pid1
 == 0){

979 
	`exô
(0);

981 
	`waô
(0);

983 
	`exô
(0);

987 
x°©us
;

988 
i
 = 0; i < 
N
; i++){

989 
	`waô
(&
x°©us
);

990 if(
x°©us
 != 0) {

991 
	`¥ötf
("%s: f‹k i¿chûd faûed", 
s
);

992 
	`exô
(1);

995 
	}
}

998 
	$f‹kf‹kf‹k
(*
s
)

1000 
	`u∆ök
("stopforking");

1002 
pid
 = 
	`f‹k
();

1003 if(
pid
 < 0){

1004 
	`¥ötf
("%s: f‹k faûed", 
s
);

1005 
	`exô
(1);

1007 if(
pid
 == 0){

1009 
fd
 = 
	`›í
("stopforking", 0);

1010 if(
fd
 >= 0){

1011 
	`exô
(0);

1013 if(
	`f‹k
() < 0){

1014 
	`˛o£
(
	`›í
("°›f‹kög", 
O_CREATE
|
O_RDWR
));

1018 
	`exô
(0);

1021 
	`¶ìp
(20);

1022 
	`˛o£
(
	`›í
("°›f‹kög", 
O_CREATE
|
O_RDWR
));

1023 
	`waô
(0);

1024 
	`¶ìp
(10);

1025 
	}
}

1033 
	$ª∑ª¡2
(*
s
)

1035 
i
 = 0; i < 800; i++){

1036 
pid1
 = 
	`f‹k
();

1037 if(
pid1
 < 0){

1038 
	`¥ötf
("fork failed\n");

1039 
	`exô
(1);

1041 if(
pid1
 == 0){

1042 
	`f‹k
();

1043 
	`f‹k
();

1044 
	`exô
(0);

1046 
	`waô
(0);

1049 
	`exô
(0);

1050 
	}
}

1054 
	$mem
(*
s
)

1056 *
m1
, *
m2
;

1057 
pid
;

1059 if((
pid
 = 
	`f‹k
()) == 0){

1060 
m1
 = 0;

1061 (
m2
 = 
	`mÆloc
(10001)) != 0){

1062 *(**)
m2
 = 
m1
;

1063 
m1
 = 
m2
;

1065 
m1
){

1066 
m2
 = *(**)
m1
;

1067 
	`‰ì
(
m1
);

1068 
m1
 = 
m2
;

1070 
m1
 = 
	`mÆloc
(1024*20);

1071 if(
m1
 == 0){

1072 
	`¥ötf
("couldn'àÆloˇã mem?!!\n", 
s
);

1073 
	`exô
(1);

1075 
	`‰ì
(
m1
);

1076 
	`exô
(0);

1078 
x°©us
;

1079 
	`waô
(&
x°©us
);

1080 if(
x°©us
 == -1){

1083 
	`exô
(0);

1085 
	`exô
(
x°©us
);

1087 
	}
}

1094 
	$sh¨edfd
(*
s
)

1096 
fd
, 
pid
, 
i
, 
n
, 
nc
, 
≈
;

1097 íum { 
N
 = 1000, 
SZ
=10};

1098 
buf
[
SZ
];

1100 
	`u∆ök
("sharedfd");

1101 
fd
 = 
	`›í
("sh¨edfd", 
O_CREATE
|
O_RDWR
);

1102 if(
fd
 < 0){

1103 
	`¥ötf
("%s: c™nŸ o≥¿sh¨edfd f‹ wrôög", 
s
);

1104 
	`exô
(1);

1106 
pid
 = 
	`f‹k
();

1107 
	`mem£t
(
buf
, 
pid
==0?'c':'p', (buf));

1108 
i
 = 0; i < 
N
; i++){

1109 if(
	`wrôe
(
fd
, 
buf
, (buf)) != (buf)){

1110 
	`¥ötf
("%s: wrôêsh¨edfd faûed\n", 
s
);

1111 
	`exô
(1);

1114 if(
pid
 == 0) {

1115 
	`exô
(0);

1117 
x°©us
;

1118 
	`waô
(&
x°©us
);

1119 if(
x°©us
 != 0)

1120 
	`exô
(
x°©us
);

1123 
	`˛o£
(
fd
);

1124 
fd
 = 
	`›í
("sharedfd", 0);

1125 if(
fd
 < 0){

1126 
	`¥ötf
("%s: c™nŸ o≥¿sh¨edfd f‹Ñódög\n", 
s
);

1127 
	`exô
(1);

1129 
nc
 = 
≈
 = 0;

1130 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0){

1131 
i
 = 0; i < (
buf
); i++){

1132 if(
buf
[
i
] == 'c')

1133 
nc
++;

1134 if(
buf
[
i
] == 'p')

1135 
≈
++;

1138 
	`˛o£
(
fd
);

1139 
	`u∆ök
("sharedfd");

1140 if(
nc
 =
N
*
SZ
 && 
≈
 == N*SZ){

1141 
	`exô
(0);

1143 
	`¥ötf
("%s:Çc/≈Åe° faûs\n", 
s
);

1144 
	`exô
(1);

1146 
	}
}

1151 
	$fourfûes
(*
s
)

1153 
fd
, 
pid
, 
i
, 
j
, 
n
, 
tŸÆ
, 
pi
;

1154 *
«mes
[] = { "f0", "f1", "f2", "f3" };

1155 *
‚ame
;

1156 íum { 
N
=12, 
NCHILD
=4, 
SZ
=500 };

1158 
pi
 = 0;Öò< 
NCHILD
;Öi++){

1159 
‚ame
 = 
«mes
[
pi
];

1160 
	`u∆ök
(
‚ame
);

1162 
pid
 = 
	`f‹k
();

1163 if(
pid
 < 0){

1164 
	`¥ötf
("f‹k faûed\n", 
s
);

1165 
	`exô
(1);

1168 if(
pid
 == 0){

1169 
fd
 = 
	`›í
(
‚ame
, 
O_CREATE
 | 
O_RDWR
);

1170 if(
fd
 < 0){

1171 
	`¥ötf
("¸óã faûed\n", 
s
);

1172 
	`exô
(1);

1175 
	`mem£t
(
buf
, '0'+
pi
, 
SZ
);

1176 
i
 = 0; i < 
N
; i++){

1177 if((
n
 = 
	`wrôe
(
fd
, 
buf
, 
SZ
)) != SZ){

1178 
	`¥ötf
("wrôêÁûed %d\n", 
n
);

1179 
	`exô
(1);

1182 
	`exô
(0);

1186 
x°©us
;

1187 
pi
 = 0;Öò< 
NCHILD
;Öi++){

1188 
	`waô
(&
x°©us
);

1189 if(
x°©us
 != 0)

1190 
	`exô
(
x°©us
);

1193 
i
 = 0; i < 
NCHILD
; i++){

1194 
‚ame
 = 
«mes
[
i
];

1195 
fd
 = 
	`›í
(
‚ame
, 0);

1196 
tŸÆ
 = 0;

1197 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0){

1198 
j
 = 0; j < 
n
; j++){

1199 if(
buf
[
j
] !'0'+
i
){

1200 
	`¥ötf
("wr⁄g ch¨\n", 
s
);

1201 
	`exô
(1);

1204 
tŸÆ
 +
n
;

1206 
	`˛o£
(
fd
);

1207 if(
tŸÆ
 !
N
*
SZ
){

1208 
	`¥ötf
("wr⁄gÜígth %d\n", 
tŸÆ
);

1209 
	`exô
(1);

1211 
	`u∆ök
(
‚ame
);

1213 
	}
}

1217 
	$¸óãdñëe
(*
s
)

1219 íum { 
N
 = 20, 
NCHILD
=4 };

1220 
pid
, 
i
, 
fd
, 
pi
;

1221 
«me
[32];

1223 
pi
 = 0;Öò< 
NCHILD
;Öi++){

1224 
pid
 = 
	`f‹k
();

1225 if(
pid
 < 0){

1226 
	`¥ötf
("f‹k faûed\n", 
s
);

1227 
	`exô
(1);

1230 if(
pid
 == 0){

1231 
«me
[0] = 'p' + 
pi
;

1232 
«me
[2] = '\0';

1233 
i
 = 0; i < 
N
; i++){

1234 
«me
[1] = '0' + 
i
;

1235 
fd
 = 
	`›í
(
«me
, 
O_CREATE
 | 
O_RDWR
);

1236 if(
fd
 < 0){

1237 
	`¥ötf
("%s: cª©êÁûed\n", 
s
);

1238 
	`exô
(1);

1240 
	`˛o£
(
fd
);

1241 if(
i
 > 0 && (i % 2 ) == 0){

1242 
«me
[1] = '0' + (
i
 / 2);

1243 if(
	`u∆ök
(
«me
) < 0){

1244 
	`¥ötf
("%s: u∆ök faûed\n", 
s
);

1245 
	`exô
(1);

1249 
	`exô
(0);

1253 
x°©us
;

1254 
pi
 = 0;Öò< 
NCHILD
;Öi++){

1255 
	`waô
(&
x°©us
);

1256 if(
x°©us
 != 0)

1257 
	`exô
(1);

1260 
«me
[0] =Çame[1] =Çame[2] = 0;

1261 
i
 = 0; i < 
N
; i++){

1262 
pi
 = 0;Öò< 
NCHILD
;Öi++){

1263 
«me
[0] = 'p' + 
pi
;

1264 
«me
[1] = '0' + 
i
;

1265 
fd
 = 
	`›í
(
«me
, 0);

1266 if((
i
 =0 || i >
N
/2Ë&& 
fd
 < 0){

1267 
	`¥ötf
("%s: o›†¸óãdñëê%†didn'àexi°\n", 
s
, 
«me
);

1268 
	`exô
(1);

1269 } if((
i
 >1 && i < 
N
/2Ë&& 
fd
 >= 0){

1270 
	`¥ötf
("%s: o›†¸óãdñëê%†didÉxi°\n", 
s
, 
«me
);

1271 
	`exô
(1);

1273 if(
fd
 >= 0)

1274 
	`˛o£
(
fd
);

1278 
i
 = 0; i < 
N
; i++){

1279 
pi
 = 0;Öò< 
NCHILD
;Öi++){

1280 
«me
[0] = 'p' + 
i
;

1281 
«me
[1] = '0' + 
i
;

1282 
	`u∆ök
(
«me
);

1285 
	}
}

1289 
	$u∆ökªad
(*
s
)

1291 íum { 
SZ
 = 5 };

1292 
fd
, 
fd1
;

1294 
fd
 = 
	`›í
("u∆ökªad", 
O_CREATE
 | 
O_RDWR
);

1295 if(
fd
 < 0){

1296 
	`¥ötf
("%s: cª©êu∆ökªad faûed\n", 
s
);

1297 
	`exô
(1);

1299 
	`wrôe
(
fd
, "hñlo", 
SZ
);

1300 
	`˛o£
(
fd
);

1302 
fd
 = 
	`›í
("u∆ökªad", 
O_RDWR
);

1303 if(
fd
 < 0){

1304 
	`¥ötf
("%s: o≥¿u∆ökªad faûed\n", 
s
);

1305 
	`exô
(1);

1307 if(
	`u∆ök
("unlinkread") != 0){

1308 
	`¥ötf
("%s: u∆ök u∆ökªad faûed\n", 
s
);

1309 
	`exô
(1);

1312 
fd1
 = 
	`›í
("u∆ökªad", 
O_CREATE
 | 
O_RDWR
);

1313 
	`wrôe
(
fd1
, "yyy", 3);

1314 
	`˛o£
(
fd1
);

1316 if(
	`ªad
(
fd
, 
buf
, (buf)Ë!
SZ
){

1317 
	`¥ötf
("%s: u∆ökªadÑód faûed", 
s
);

1318 
	`exô
(1);

1320 if(
buf
[0] != 'h'){

1321 
	`¥ötf
("%s: u∆ökªad wr⁄g d©a\n", 
s
);

1322 
	`exô
(1);

1324 if(
	`wrôe
(
fd
, 
buf
, 10) != 10){

1325 
	`¥ötf
("%s: u∆ökªad wrôêÁûed\n", 
s
);

1326 
	`exô
(1);

1328 
	`˛o£
(
fd
);

1329 
	`u∆ök
("unlinkread");

1330 
	}
}

1333 
	$lökã°
(*
s
)

1335 íum { 
SZ
 = 5 };

1336 
fd
;

1338 
	`u∆ök
("lf1");

1339 
	`u∆ök
("lf2");

1341 
fd
 = 
	`›í
("lf1", 
O_CREATE
|
O_RDWR
);

1342 if(
fd
 < 0){

1343 
	`¥ötf
("%s: cª©êlf1 faûed\n", 
s
);

1344 
	`exô
(1);

1346 if(
	`wrôe
(
fd
, "hñlo", 
SZ
) != SZ){

1347 
	`¥ötf
("%s: wrôêlf1 faûed\n", 
s
);

1348 
	`exô
(1);

1350 
	`˛o£
(
fd
);

1352 if(
	`lök
("lf1", "lf2") < 0){

1353 
	`¥ötf
("%s:ÜökÜf1Üf2 faûed\n", 
s
);

1354 
	`exô
(1);

1356 
	`u∆ök
("lf1");

1358 if(
	`›í
("lf1", 0) >= 0){

1359 
	`¥ötf
("%s: u∆ökedÜf1 buàô i†°û»thîe!\n", 
s
);

1360 
	`exô
(1);

1363 
fd
 = 
	`›í
("lf2", 0);

1364 if(
fd
 < 0){

1365 
	`¥ötf
("%s: o≥¿lf2 faûed\n", 
s
);

1366 
	`exô
(1);

1368 if(
	`ªad
(
fd
, 
buf
, (buf)Ë!
SZ
){

1369 
	`¥ötf
("%s:ÑódÜf2 faûed\n", 
s
);

1370 
	`exô
(1);

1372 
	`˛o£
(
fd
);

1374 if(
	`lök
("lf2", "lf2") >= 0){

1375 
	`¥ötf
("%s:ÜökÜf2Üf2 suc˚eded! o›s\n", 
s
);

1376 
	`exô
(1);

1379 
	`u∆ök
("lf2");

1380 if(
	`lök
("lf2", "lf1") >= 0){

1381 
	`¥ötf
("%s:ÜökÇ⁄-exi°íàsuc˚eded! o›s\n", 
s
);

1382 
	`exô
(1);

1385 if(
	`lök
(".", "lf1") >= 0){

1386 
	`¥ötf
("%s:Üök .Üf1 suc˚eded! o›s\n", 
s
);

1387 
	`exô
(1);

1389 
	}
}

1393 
	$c⁄¸óã
(*
s
)

1395 íum { 
N
 = 40 };

1396 
fûe
[3];

1397 
i
, 
pid
, 
n
, 
fd
;

1398 
Á
[
N
];

1400 
ush‹t
 
öum
;

1401 
«me
[
DIRSIZ
];

1402 } 
de
;

1404 
fûe
[0] = 'C';

1405 
fûe
[2] = '\0';

1406 
i
 = 0; i < 
N
; i++){

1407 
fûe
[1] = '0' + 
i
;

1408 
	`u∆ök
(
fûe
);

1409 
pid
 = 
	`f‹k
();

1410 if(
pid
 && (
i
 % 3) == 1){

1411 
	`lök
("C0", 
fûe
);

1412 } if(
pid
 =0 && (
i
 % 5) == 1){

1413 
	`lök
("C0", 
fûe
);

1415 
fd
 = 
	`›í
(
fûe
, 
O_CREATE
 | 
O_RDWR
);

1416 if(
fd
 < 0){

1417 
	`¥ötf
("c⁄¸óã cª©ê%†Áûed\n", 
fûe
);

1418 
	`exô
(1);

1420 
	`˛o£
(
fd
);

1422 if(
pid
 == 0) {

1423 
	`exô
(0);

1425 
x°©us
;

1426 
	`waô
(&
x°©us
);

1427 if(
x°©us
 != 0)

1428 
	`exô
(1);

1432 
	`mem£t
(
Á
, 0, (fa));

1433 
fd
 = 
	`›í
(".", 0);

1434 
n
 = 0;

1435 
	`ªad
(
fd
, &
de
, (de)) > 0){

1436 if(
de
.
öum
 == 0)

1438 if(
de
.
«me
[0] == 'C' && de.name[2] == '\0'){

1439 
i
 = 
de
.
«me
[1] - '0';

1440 if(
i
 < 0 || i >(
Á
)){

1441 
	`¥ötf
("%s: c⁄¸óã weúd fûê%s\n", 
s
, 
de
.
«me
);

1442 
	`exô
(1);

1444 if(
Á
[
i
]){

1445 
	`¥ötf
("%s: c⁄¸óã du∂iˇã fûê%s\n", 
s
, 
de
.
«me
);

1446 
	`exô
(1);

1448 
Á
[
i
] = 1;

1449 
n
++;

1452 
	`˛o£
(
fd
);

1454 if(
n
 !
N
){

1455 
	`¥ötf
("%s: c⁄¸óãÇŸÉnough fûe†ö dúe˘‹yÜi°ög\n", 
s
);

1456 
	`exô
(1);

1459 
i
 = 0; i < 
N
; i++){

1460 
fûe
[1] = '0' + 
i
;

1461 
pid
 = 
	`f‹k
();

1462 if(
pid
 < 0){

1463 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

1464 
	`exô
(1);

1466 if(((
i
 % 3Ë=0 && 
pid
 == 0) ||

1467 ((
i
 % 3Ë=1 && 
pid
 != 0)){

1468 
	`˛o£
(
	`›í
(
fûe
, 0));

1469 
	`˛o£
(
	`›í
(
fûe
, 0));

1470 
	`˛o£
(
	`›í
(
fûe
, 0));

1471 
	`˛o£
(
	`›í
(
fûe
, 0));

1472 
	`˛o£
(
	`›í
(
fûe
, 0));

1473 
	`˛o£
(
	`›í
(
fûe
, 0));

1475 
	`u∆ök
(
fûe
);

1476 
	`u∆ök
(
fûe
);

1477 
	`u∆ök
(
fûe
);

1478 
	`u∆ök
(
fûe
);

1479 
	`u∆ök
(
fûe
);

1480 
	`u∆ök
(
fûe
);

1482 if(
pid
 == 0)

1483 
	`exô
(0);

1485 
	`waô
(0);

1487 
	}
}

1492 
	$löku∆ök
(*
s
)

1494 
pid
, 
i
;

1496 
	`u∆ök
("x");

1497 
pid
 = 
	`f‹k
();

1498 if(
pid
 < 0){

1499 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

1500 
	`exô
(1);

1503 
x
 = (
pid
 ? 1 : 97);

1504 
i
 = 0; i < 100; i++){

1505 
x
 = x * 1103515245 + 12345;

1506 if((
x
 % 3) == 0){

1507 
	`˛o£
(
	`›í
("x", 
O_RDWR
 | 
O_CREATE
));

1508 } if((
x
 % 3) == 1){

1509 
	`lök
("cat", "x");

1511 
	`u∆ök
("x");

1515 if(
pid
)

1516 
	`waô
(0);

1518 
	`exô
(0);

1519 
	}
}

1523 
	$subdú
(*
s
)

1525 
fd
, 
cc
;

1527 
	`u∆ök
("ff");

1528 if(
	`mkdú
("dd") != 0){

1529 
	`¥ötf
("%s: mkdú dd faûed\n", 
s
);

1530 
	`exô
(1);

1533 
fd
 = 
	`›í
("dd/ff", 
O_CREATE
 | 
O_RDWR
);

1534 if(
fd
 < 0){

1535 
	`¥ötf
("%s: cª©êdd/f‡Áûed\n", 
s
);

1536 
	`exô
(1);

1538 
	`wrôe
(
fd
, "ff", 2);

1539 
	`˛o£
(
fd
);

1541 if(
	`u∆ök
("dd") >= 0){

1542 
	`¥ötf
("%s: u∆ök dd (n⁄-em±y dúËsuc˚eded!\n", 
s
);

1543 
	`exô
(1);

1546 if(
	`mkdú
("/dd/dd") != 0){

1547 
	`¥ötf
("subdú mkdú dd/dd faûed\n", 
s
);

1548 
	`exô
(1);

1551 
fd
 = 
	`›í
("dd/dd/ff", 
O_CREATE
 | 
O_RDWR
);

1552 if(
fd
 < 0){

1553 
	`¥ötf
("%s: cª©êdd/dd/f‡Áûed\n", 
s
);

1554 
	`exô
(1);

1556 
	`wrôe
(
fd
, "FF", 2);

1557 
	`˛o£
(
fd
);

1559 
fd
 = 
	`›í
("dd/dd/../ff", 0);

1560 if(
fd
 < 0){

1561 
	`¥ötf
("%s: o≥¿dd/dd/../f‡Áûed\n", 
s
);

1562 
	`exô
(1);

1564 
cc
 = 
	`ªad
(
fd
, 
buf
, (buf));

1565 if(
cc
 !2 || 
buf
[0] != 'f'){

1566 
	`¥ötf
("%s: dd/dd/../f‡wr⁄g c⁄ã¡\n", 
s
);

1567 
	`exô
(1);

1569 
	`˛o£
(
fd
);

1571 if(
	`lök
("dd/dd/ff", "dd/dd/ffff") != 0){

1572 
	`¥ötf
("lök dd/dd/f‡dd/dd/fff‡Áûed\n", 
s
);

1573 
	`exô
(1);

1576 if(
	`u∆ök
("dd/dd/ff") != 0){

1577 
	`¥ötf
("%s: u∆ök dd/dd/f‡Áûed\n", 
s
);

1578 
	`exô
(1);

1580 if(
	`›í
("dd/dd/ff", 
O_RDONLY
) >= 0){

1581 
	`¥ötf
("%s: o≥¿(u∆ökedËdd/dd/f‡suc˚eded\n", 
s
);

1582 
	`exô
(1);

1585 if(
	`chdú
("dd") != 0){

1586 
	`¥ötf
("%s: chdú dd faûed\n", 
s
);

1587 
	`exô
(1);

1589 if(
	`chdú
("dd/../../dd") != 0){

1590 
	`¥ötf
("%s: chdú dd/../../dd faûed\n", 
s
);

1591 
	`exô
(1);

1593 if(
	`chdú
("dd/../../../dd") != 0){

1594 
	`¥ötf
("chdú dd/../../dd faûed\n", 
s
);

1595 
	`exô
(1);

1597 if(
	`chdú
("./..") != 0){

1598 
	`¥ötf
("%s: chdú ./.. faûed\n", 
s
);

1599 
	`exô
(1);

1602 
fd
 = 
	`›í
("dd/dd/ffff", 0);

1603 if(
fd
 < 0){

1604 
	`¥ötf
("%s: o≥¿dd/dd/fff‡Áûed\n", 
s
);

1605 
	`exô
(1);

1607 if(
	`ªad
(
fd
, 
buf
, (buf)) != 2){

1608 
	`¥ötf
("%s:Ñód dd/dd/fff‡wr⁄gÜí\n", 
s
);

1609 
	`exô
(1);

1611 
	`˛o£
(
fd
);

1613 if(
	`›í
("dd/dd/ff", 
O_RDONLY
) >= 0){

1614 
	`¥ötf
("%s: o≥¿(u∆ökedËdd/dd/f‡suc˚eded!\n", 
s
);

1615 
	`exô
(1);

1618 if(
	`›í
("dd/ff/ff", 
O_CREATE
|
O_RDWR
) >= 0){

1619 
	`¥ötf
("%s: cª©êdd/ff/f‡suc˚eded!\n", 
s
);

1620 
	`exô
(1);

1622 if(
	`›í
("dd/xx/ff", 
O_CREATE
|
O_RDWR
) >= 0){

1623 
	`¥ötf
("%s: cª©êdd/xx/f‡suc˚eded!\n", 
s
);

1624 
	`exô
(1);

1626 if(
	`›í
("dd", 
O_CREATE
) >= 0){

1627 
	`¥ötf
("%s: cª©êdd suc˚eded!\n", 
s
);

1628 
	`exô
(1);

1630 if(
	`›í
("dd", 
O_RDWR
) >= 0){

1631 
	`¥ötf
("%s: o≥¿ddÑdw∏suc˚eded!\n", 
s
);

1632 
	`exô
(1);

1634 if(
	`›í
("dd", 
O_WRONLY
) >= 0){

1635 
	`¥ötf
("%s: o≥¿dd wr⁄ly suc˚eded!\n", 
s
);

1636 
	`exô
(1);

1638 if(
	`lök
("dd/ff/ff", "dd/dd/xx") == 0){

1639 
	`¥ötf
("%s:Üök dd/ff/f‡dd/dd/xx suc˚eded!\n", 
s
);

1640 
	`exô
(1);

1642 if(
	`lök
("dd/xx/ff", "dd/dd/xx") == 0){

1643 
	`¥ötf
("%s:Üök dd/xx/f‡dd/dd/xx suc˚eded!\n", 
s
);

1644 
	`exô
(1);

1646 if(
	`lök
("dd/ff", "dd/dd/ffff") == 0){

1647 
	`¥ötf
("%s:Üök dd/f‡dd/dd/fff‡suc˚eded!\n", 
s
);

1648 
	`exô
(1);

1650 if(
	`mkdú
("dd/ff/ff") == 0){

1651 
	`¥ötf
("%s: mkdú dd/ff/f‡suc˚eded!\n", 
s
);

1652 
	`exô
(1);

1654 if(
	`mkdú
("dd/xx/ff") == 0){

1655 
	`¥ötf
("%s: mkdú dd/xx/f‡suc˚eded!\n", 
s
);

1656 
	`exô
(1);

1658 if(
	`mkdú
("dd/dd/ffff") == 0){

1659 
	`¥ötf
("%s: mkdú dd/dd/fff‡suc˚eded!\n", 
s
);

1660 
	`exô
(1);

1662 if(
	`u∆ök
("dd/xx/ff") == 0){

1663 
	`¥ötf
("%s: u∆ök dd/xx/f‡suc˚eded!\n", 
s
);

1664 
	`exô
(1);

1666 if(
	`u∆ök
("dd/ff/ff") == 0){

1667 
	`¥ötf
("%s: u∆ök dd/ff/f‡suc˚eded!\n", 
s
);

1668 
	`exô
(1);

1670 if(
	`chdú
("dd/ff") == 0){

1671 
	`¥ötf
("%s: chdú dd/f‡suc˚eded!\n", 
s
);

1672 
	`exô
(1);

1674 if(
	`chdú
("dd/xx") == 0){

1675 
	`¥ötf
("%s: chdú dd/xx suc˚eded!\n", 
s
);

1676 
	`exô
(1);

1679 if(
	`u∆ök
("dd/dd/ffff") != 0){

1680 
	`¥ötf
("%s: u∆ök dd/dd/f‡Áûed\n", 
s
);

1681 
	`exô
(1);

1683 if(
	`u∆ök
("dd/ff") != 0){

1684 
	`¥ötf
("%s: u∆ök dd/f‡Áûed\n", 
s
);

1685 
	`exô
(1);

1687 if(
	`u∆ök
("dd") == 0){

1688 
	`¥ötf
("%s: u∆ökÇ⁄-em±y dd suc˚eded!\n", 
s
);

1689 
	`exô
(1);

1691 if(
	`u∆ök
("dd/dd") < 0){

1692 
	`¥ötf
("%s: u∆ök dd/dd faûed\n", 
s
);

1693 
	`exô
(1);

1695 if(
	`u∆ök
("dd") < 0){

1696 
	`¥ötf
("%s: u∆ök dd faûed\n", 
s
);

1697 
	`exô
(1);

1699 
	}
}

1703 
	$bigwrôe
(*
s
)

1705 
fd
, 
sz
;

1707 
	`u∆ök
("bigwrite");

1708 
sz
 = 499; sz < (
MAXOPBLOCKS
+2)*
BSIZE
; sz += 471){

1709 
fd
 = 
	`›í
("bigwrôe", 
O_CREATE
 | 
O_RDWR
);

1710 if(
fd
 < 0){

1711 
	`¥ötf
("%s: c™nŸ cª©êbigwrôe\n", 
s
);

1712 
	`exô
(1);

1714 
i
;

1715 
i
 = 0; i < 2; i++){

1716 
cc
 = 
	`wrôe
(
fd
, 
buf
, 
sz
);

1717 if(
cc
 !
sz
){

1718 
	`¥ötf
("%s: wrôe(%dËªà%d\n", 
s
, 
sz
, 
cc
);

1719 
	`exô
(1);

1722 
	`˛o£
(
fd
);

1723 
	`u∆ök
("bigwrite");

1725 
	}
}

1729 
	$bigfûe
(*
s
)

1731 íum { 
N
 = 20, 
SZ
=600 };

1732 
fd
, 
i
, 
tŸÆ
, 
cc
;

1734 
	`u∆ök
("bigfile.dat");

1735 
fd
 = 
	`›í
("bigfûe.d©", 
O_CREATE
 | 
O_RDWR
);

1736 if(
fd
 < 0){

1737 
	`¥ötf
("%s: c™nŸ cª©êbigfûe", 
s
);

1738 
	`exô
(1);

1740 
i
 = 0; i < 
N
; i++){

1741 
	`mem£t
(
buf
, 
i
, 
SZ
);

1742 if(
	`wrôe
(
fd
, 
buf
, 
SZ
) != SZ){

1743 
	`¥ötf
("%s: wrôêbigfûêÁûed\n", 
s
);

1744 
	`exô
(1);

1747 
	`˛o£
(
fd
);

1749 
fd
 = 
	`›í
("bigfile.dat", 0);

1750 if(
fd
 < 0){

1751 
	`¥ötf
("%s: c™nŸ o≥¿bigfûe\n", 
s
);

1752 
	`exô
(1);

1754 
tŸÆ
 = 0;

1755 
i
 = 0; ; i++){

1756 
cc
 = 
	`ªad
(
fd
, 
buf
, 
SZ
/2);

1757 if(
cc
 < 0){

1758 
	`¥ötf
("%s:Ñód bigfûêÁûed\n", 
s
);

1759 
	`exô
(1);

1761 if(
cc
 == 0)

1763 if(
cc
 !
SZ
/2){

1764 
	`¥ötf
("%s: sh‹àªad bigfûe\n", 
s
);

1765 
	`exô
(1);

1767 if(
buf
[0] !
i
/2 || buf[
SZ
/2-1] != i/2){

1768 
	`¥ötf
("%s:Ñód bigfûêwr⁄g d©a\n", 
s
);

1769 
	`exô
(1);

1771 
tŸÆ
 +
cc
;

1773 
	`˛o£
(
fd
);

1774 if(
tŸÆ
 !
N
*
SZ
){

1775 
	`¥ötf
("%s:Ñód bigfûêwr⁄gÅŸÆ\n", 
s
);

1776 
	`exô
(1);

1778 
	`u∆ök
("bigfile.dat");

1779 
	}
}

1782 
	$fouπìn
(*
s
)

1784 
fd
;

1788 if(
	`mkdú
("12345678901234") != 0){

1789 
	`¥ötf
("%s: mkdú 12345678901234 faûed\n", 
s
);

1790 
	`exô
(1);

1792 if(
	`mkdú
("12345678901234/123456789012345") != 0){

1793 
	`¥ötf
("%s: mkdú 12345678901234/123456789012345 faûed\n", 
s
);

1794 
	`exô
(1);

1796 
fd
 = 
	`›í
("123456789012345/123456789012345/123456789012345", 
O_CREATE
);

1797 if(
fd
 < 0){

1798 
	`¥ötf
("%s: cª©ê123456789012345/123456789012345/123456789012345 faûed\n", 
s
);

1799 
	`exô
(1);

1801 
	`˛o£
(
fd
);

1802 
fd
 = 
	`›í
("12345678901234/12345678901234/12345678901234", 0);

1803 if(
fd
 < 0){

1804 
	`¥ötf
("%s: o≥¿12345678901234/12345678901234/12345678901234 faûed\n", 
s
);

1805 
	`exô
(1);

1807 
	`˛o£
(
fd
);

1809 if(
	`mkdú
("12345678901234/12345678901234") == 0){

1810 
	`¥ötf
("%s: mkdú 12345678901234/12345678901234 suc˚eded!\n", 
s
);

1811 
	`exô
(1);

1813 if(
	`mkdú
("123456789012345/12345678901234") == 0){

1814 
	`¥ötf
("%s: mkdú 12345678901234/123456789012345 suc˚eded!\n", 
s
);

1815 
	`exô
(1);

1819 
	`u∆ök
("123456789012345/12345678901234");

1820 
	`u∆ök
("12345678901234/12345678901234");

1821 
	`u∆ök
("12345678901234/12345678901234/12345678901234");

1822 
	`u∆ök
("123456789012345/123456789012345/123456789012345");

1823 
	`u∆ök
("12345678901234/123456789012345");

1824 
	`u∆ök
("12345678901234");

1825 
	}
}

1828 
	$rmdŸ
(*
s
)

1830 if(
	`mkdú
("dots") != 0){

1831 
	`¥ötf
("%s: mkdú dŸ†Áûed\n", 
s
);

1832 
	`exô
(1);

1834 if(
	`chdú
("dots") != 0){

1835 
	`¥ötf
("%s: chdú dŸ†Áûed\n", 
s
);

1836 
	`exô
(1);

1838 if(
	`u∆ök
(".") == 0){

1839 
	`¥ötf
("%s:Ñm . w‹ked!\n", 
s
);

1840 
	`exô
(1);

1842 if(
	`u∆ök
("..") == 0){

1843 
	`¥ötf
("%s:Ñm .. w‹ked!\n", 
s
);

1844 
	`exô
(1);

1846 if(
	`chdú
("/") != 0){

1847 
	`¥ötf
("%s: chdú / faûed\n", 
s
);

1848 
	`exô
(1);

1850 if(
	`u∆ök
("dots/.") == 0){

1851 
	`¥ötf
("%s: u∆ök dŸs/. w‹ked!\n", 
s
);

1852 
	`exô
(1);

1854 if(
	`u∆ök
("dots/..") == 0){

1855 
	`¥ötf
("%s: u∆ök dŸs/.. w‹ked!\n", 
s
);

1856 
	`exô
(1);

1858 if(
	`u∆ök
("dots") != 0){

1859 
	`¥ötf
("%s: u∆ök dŸ†Áûed!\n", 
s
);

1860 
	`exô
(1);

1862 
	}
}

1865 
	$dúfûe
(*
s
)

1867 
fd
;

1869 
fd
 = 
	`›í
("dúfûe", 
O_CREATE
);

1870 if(
fd
 < 0){

1871 
	`¥ötf
("%s: cª©êdúfûêÁûed\n", 
s
);

1872 
	`exô
(1);

1874 
	`˛o£
(
fd
);

1875 if(
	`chdú
("dirfile") == 0){

1876 
	`¥ötf
("%s: chdú dúfûêsuc˚eded!\n", 
s
);

1877 
	`exô
(1);

1879 
fd
 = 
	`›í
("dirfile/xx", 0);

1880 if(
fd
 >= 0){

1881 
	`¥ötf
("%s: cª©êdúfûe/xx suc˚eded!\n", 
s
);

1882 
	`exô
(1);

1884 
fd
 = 
	`›í
("dúfûe/xx", 
O_CREATE
);

1885 if(
fd
 >= 0){

1886 
	`¥ötf
("%s: cª©êdúfûe/xx suc˚eded!\n", 
s
);

1887 
	`exô
(1);

1889 if(
	`mkdú
("dirfile/xx") == 0){

1890 
	`¥ötf
("%s: mkdú dúfûe/xx suc˚eded!\n", 
s
);

1891 
	`exô
(1);

1893 if(
	`u∆ök
("dirfile/xx") == 0){

1894 
	`¥ötf
("%s: u∆ök dúfûe/xx suc˚eded!\n", 
s
);

1895 
	`exô
(1);

1897 if(
	`lök
("README", "dirfile/xx") == 0){

1898 
	`¥ötf
("%s:ÜökÅÿdúfûe/xx suc˚eded!\n", 
s
);

1899 
	`exô
(1);

1901 if(
	`u∆ök
("dirfile") != 0){

1902 
	`¥ötf
("%s: u∆ök dúfûêÁûed!\n", 
s
);

1903 
	`exô
(1);

1906 
fd
 = 
	`›í
(".", 
O_RDWR
);

1907 if(
fd
 >= 0){

1908 
	`¥ötf
("%s: o≥¿. f‹ wrôög suc˚eded!\n", 
s
);

1909 
	`exô
(1);

1911 
fd
 = 
	`›í
(".", 0);

1912 if(
	`wrôe
(
fd
, "x", 1) > 0){

1913 
	`¥ötf
("%s: wrôê. suc˚eded!\n", 
s
);

1914 
	`exô
(1);

1916 
	`˛o£
(
fd
);

1917 
	}
}

1922 
	$úef
(*
s
)

1924 
i
, 
fd
;

1926 
i
 = 0; i < 
NINODE
 + 1; i++){

1927 if(
	`mkdú
("irefd") != 0){

1928 
	`¥ötf
("%s: mkdú iªfd faûed\n", 
s
);

1929 
	`exô
(1);

1931 if(
	`chdú
("irefd") != 0){

1932 
	`¥ötf
("%s: chdú iªfd faûed\n", 
s
);

1933 
	`exô
(1);

1936 
	`mkdú
("");

1937 
	`lök
("README", "");

1938 
fd
 = 
	`›í
("", 
O_CREATE
);

1939 if(
fd
 >= 0)

1940 
	`˛o£
(
fd
);

1941 
fd
 = 
	`›í
("xx", 
O_CREATE
);

1942 if(
fd
 >= 0)

1943 
	`˛o£
(
fd
);

1944 
	`u∆ök
("xx");

1948 
i
 = 0; i < 
NINODE
 + 1; i++){

1949 
	`chdú
("..");

1950 
	`u∆ök
("irefd");

1953 
	`chdú
("/");

1954 
	}
}

1960 
	$f‹kã°
(*
s
)

1962 íum{ 
N
 = 1000 };

1963 
n
, 
pid
;

1965 
n
=0;Ç<
N
;Ç++){

1966 
pid
 = 
	`f‹k
();

1967 if(
pid
 < 0)

1969 if(
pid
 == 0)

1970 
	`exô
(0);

1973 i‡(
n
 == 0) {

1974 
	`¥ötf
("%s:Çÿf‹káàÆl!\n", 
s
);

1975 
	`exô
(1);

1978 if(
n
 =
N
){

1979 
	`¥ötf
("%s: f‹k cœimedÅÿw‹k 1000Åimes!\n", 
s
);

1980 
	`exô
(1);

1983 ; 
n
 > 0;Ç--){

1984 if(
	`waô
(0) < 0){

1985 
	`¥ötf
("%s: waô st›≥dÉ¨ly\n", 
s
);

1986 
	`exô
(1);

1990 if(
	`waô
(0) != -1){

1991 
	`¥ötf
("%s: waô gŸÅoÿm™y\n", 
s
);

1992 
	`exô
(1);

1994 
	}
}

1997 
	$sbrkbasic
(*
s
)

1999 íum { 
TOOMUCH
=1024*1024*1024};

2000 
i
, 
pid
, 
x°©us
;

2001 *
c
, *
a
, *
b
;

2004 
pid
 = 
	`f‹k
();

2005 if(
pid
 < 0){

2006 
	`¥ötf
("fork failed in sbrkbasic\n");

2007 
	`exô
(1);

2009 if(
pid
 == 0){

2010 
a
 = 
	`sbrk
(
TOOMUCH
);

2011 if(
a
 == (*)0xffffffffffffffffL){

2013 
	`exô
(0);

2016 
b
 = 
a
; b <á+
TOOMUCH
; b += 4096){

2017 *
b
 = 99;

2023 
	`exô
(1);

2026 
	`waô
(&
x°©us
);

2027 if(
x°©us
 == 1){

2028 
	`¥ötf
("%s:Åoÿmuch mem‹yáŒoˇãd!\n", 
s
);

2029 
	`exô
(1);

2033 
a
 = 
	`sbrk
(0);

2034 
i
 = 0; i < 5000; i++){

2035 
b
 = 
	`sbrk
(1);

2036 if(
b
 !
a
){

2037 
	`¥ötf
("%s: sbrkÅe° faûed %d %x %x\n", 
s
, 
i
, 
a
, 
b
);

2038 
	`exô
(1);

2040 *
b
 = 1;

2041 
a
 = 
b
 + 1;

2043 
pid
 = 
	`f‹k
();

2044 if(
pid
 < 0){

2045 
	`¥ötf
("%s: sbrkÅe° f‹k faûed\n", 
s
);

2046 
	`exô
(1);

2048 
c
 = 
	`sbrk
(1);

2049 
c
 = 
	`sbrk
(1);

2050 if(
c
 !
a
 + 1){

2051 
	`¥ötf
("%s: sbrkÅe° faûedÖo°-f‹k\n", 
s
);

2052 
	`exô
(1);

2054 if(
pid
 == 0)

2055 
	`exô
(0);

2056 
	`waô
(&
x°©us
);

2057 
	`exô
(
x°©us
);

2058 
	}
}

2061 
	$sbrkmuch
(*
s
)

2063 íum { 
BIG
=100*1024*1024 };

2064 *
c
, *
ﬁdbrk
, *
a
, *
œ°addr
, *
p
;

2065 
uöt64
 
amt
;

2067 
ﬁdbrk
 = 
	`sbrk
(0);

2070 
a
 = 
	`sbrk
(0);

2071 
amt
 = 
BIG
 - (
uöt64
)
a
;

2072 
p
 = 
	`sbrk
(
amt
);

2073 i‡(
p
 !
a
) {

2074 
	`¥ötf
("%s: sbrkÅe° faûedÅÿgrow bigáddªs†•a˚;ÉnoughÖhy†mem?\n", 
s
);

2075 
	`exô
(1);

2079 *
ìe
 = 
	`sbrk
(0);

2080 *
µ
 = 
a
;Ö∞< 
ìe
;Öp += 4096)

2081 *
µ
 = 1;

2083 
œ°addr
 = (*Ë(
BIG
-1);

2084 *
œ°addr
 = 99;

2087 
a
 = 
	`sbrk
(0);

2088 
c
 = 
	`sbrk
(-
PGSIZE
);

2089 if(
c
 == (*)0xffffffffffffffffL){

2090 
	`¥ötf
("%s: sbrk couldÇŸ dóŒoˇã\n", 
s
);

2091 
	`exô
(1);

2093 
c
 = 
	`sbrk
(0);

2094 if(
c
 !
a
 - 
PGSIZE
){

2095 
	`¥ötf
("%s: sbrk dóŒoˇti⁄Örodu˚d wr⁄gáddªss,á %x c %x\n", 
s
, 
a
, 
c
);

2096 
	`exô
(1);

2100 
a
 = 
	`sbrk
(0);

2101 
c
 = 
	`sbrk
(
PGSIZE
);

2102 if(
c
 !
a
 || 
	`sbrk
(0Ë!®+ 
PGSIZE
){

2103 
	`¥ötf
("%s: sbrkÑe-Æloˇti⁄ faûed,á %x c %x\n", 
s
, 
a
, 
c
);

2104 
	`exô
(1);

2106 if(*
œ°addr
 == 99){

2108 
	`¥ötf
("%s: sbrk de-Æloˇti⁄ didn'àªÆly dóŒoˇã\n", 
s
);

2109 
	`exô
(1);

2112 
a
 = 
	`sbrk
(0);

2113 
c
 = 
	`sbrk
(-(sbrk(0Ë- 
ﬁdbrk
));

2114 if(
c
 !
a
){

2115 
	`¥ötf
("%s: sbrk downsizêÁûed,á %x c %x\n", 
s
, 
a
, 
c
);

2116 
	`exô
(1);

2118 
	}
}

2122 
	$kînmem
(*
s
)

2124 *
a
;

2125 
pid
;

2127 
a
 = (*)(
KERNBASE
);á < (*) (KERNBASE+2000000);á += 50000){

2128 
pid
 = 
	`f‹k
();

2129 if(
pid
 < 0){

2130 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

2131 
	`exô
(1);

2133 if(
pid
 == 0){

2134 
	`¥ötf
("%s: o›†couldÑód %x = %x\n", 
s
, 
a
, *a);

2135 
	`exô
(1);

2137 
x°©us
;

2138 
	`waô
(&
x°©us
);

2139 if(
x°©us
 != -1)

2140 
	`exô
(1);

2142 
	}
}

2146 
	$MAXVA∂us
(*
s
)

2148 vﬁ©ûê
uöt64
 
a
 = 
MAXVA
;

2149  ; 
a
 != 0;á <<= 1){

2150 
pid
;

2151 
pid
 = 
	`f‹k
();

2152 if(
pid
 < 0){

2153 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

2154 
	`exô
(1);

2156 if(
pid
 == 0){

2157 *(*)
a
 = 99;

2158 
	`¥ötf
("%s: o›†wrŸê%x\n", 
s
, 
a
);

2159 
	`exô
(1);

2161 
x°©us
;

2162 
	`waô
(&
x°©us
);

2163 if(
x°©us
 != -1)

2164 
	`exô
(1);

2166 
	}
}

2171 
	$sbrkÁû
(*
s
)

2173 íum { 
BIG
=100*1024*1024 };

2174 
i
, 
x°©us
;

2175 
fds
[2];

2176 
s¸©ch
;

2177 *
c
, *
a
;

2178 
pids
[10];

2179 
pid
;

2181 if(
	`pùe
(
fds
) != 0){

2182 
	`¥ötf
("%s:Öùe(ËÁûed\n", 
s
);

2183 
	`exô
(1);

2185 
i
 = 0; i < (
pids
)/(pids[0]); i++){

2186 if((
pids
[
i
] = 
	`f‹k
()) == 0){

2188 
	`sbrk
(
BIG
 - (
uöt64
)sbrk(0));

2189 
	`wrôe
(
fds
[1], "x", 1);

2191 ;;Ë
	`¶ìp
(1000);

2193 if(
pids
[
i
] != -1)

2194 
	`ªad
(
fds
[0], &
s¸©ch
, 1);

2199 
c
 = 
	`sbrk
(
PGSIZE
);

2200 
i
 = 0; i < (
pids
)/(pids[0]); i++){

2201 if(
pids
[
i
] == -1)

2203 
	`kûl
(
pids
[
i
]);

2204 
	`waô
(0);

2206 if(
c
 == (*)0xffffffffffffffffL){

2207 
	`¥ötf
("%s: faûed sbrkÜóked mem‹y\n", 
s
);

2208 
	`exô
(1);

2212 
pid
 = 
	`f‹k
();

2213 if(
pid
 < 0){

2214 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

2215 
	`exô
(1);

2217 if(
pid
 == 0){

2221 
a
 = 
	`sbrk
(0);

2222 
	`sbrk
(10*
BIG
);

2223 
n
 = 0;

2224 
i
 = 0; i < 10*
BIG
; i +
PGSIZE
) {

2225 
n
 +*(
a
+
i
);

2229 
	`¥ötf
("%s:áŒoˇãáÜŸ o‡mem‹y suc˚eded %d\n", 
s
, 
n
);

2230 
	`exô
(1);

2232 
	`waô
(&
x°©us
);

2233 if(
x°©us
 != -1 && xstatus != 2)

2234 
	`exô
(1);

2235 
	}
}

2240 
	$sbrk¨g
(*
s
)

2242 *
a
;

2243 
fd
, 
n
;

2245 
a
 = 
	`sbrk
(
PGSIZE
);

2246 
fd
 = 
	`›í
("sbrk", 
O_CREATE
|
O_WRONLY
);

2247 
	`u∆ök
("sbrk");

2248 if(
fd
 < 0) {

2249 
	`¥ötf
("%s: o≥¿sbrk faûed\n", 
s
);

2250 
	`exô
(1);

2252 i‡((
n
 = 
	`wrôe
(
fd
, 
a
, 
PGSIZE
)) < 0) {

2253 
	`¥ötf
("%s: wrôêsbrk faûed\n", 
s
);

2254 
	`exô
(1);

2256 
	`˛o£
(
fd
);

2259 
a
 = 
	`sbrk
(
PGSIZE
);

2260 if(
	`pùe
((*Ë
a
) != 0){

2261 
	`¥ötf
("%s:Öùe(ËÁûed\n", 
s
);

2262 
	`exô
(1);

2264 
	}
}

2267 
	$vÆid©ëe°
(*
s
)

2269 
hi
;

2270 
uöt64
 
p
;

2272 
hi
 = 1100*1024;

2273 
p
 = 0;Ö <(
uöt
)
hi
;Ö +
PGSIZE
){

2275 if(
	`lök
("nosuchfûe", (*)
p
) != -1){

2276 
	`¥ötf
("%s:Üök shouldÇŸ suc˚ed\n", 
s
);

2277 
	`exô
(1);

2280 
	}
}

2283 
	gunöô
[10000];

2285 
	$bs°e°
(*
s
)

2287 
i
;

2289 
i
 = 0; i < (
unöô
); i++){

2290 if(
unöô
[
i
] != '\0'){

2291 
	`¥ötf
("%s: bs†ã° faûed\n", 
s
);

2292 
	`exô
(1);

2295 
	}
}

2301 
	$big¨gã°
(*
s
)

2303 
pid
, 
fd
, 
x°©us
;

2305 
	`u∆ök
("bigarg-ok");

2306 
pid
 = 
	`f‹k
();

2307 if(
pid
 == 0){

2308 *
¨gs
[
MAXARG
];

2309 
i
;

2310 
i
 = 0; i < 
MAXARG
-1; i++)

2311 
¨gs
[
i
] = "bigargsÅest: failed\n ";

2312 
¨gs
[
MAXARG
-1] = 0;

2313 
	`exec
("echo", 
¨gs
);

2314 
fd
 = 
	`›í
("big¨g-ok", 
O_CREATE
);

2315 
	`˛o£
(
fd
);

2316 
	`exô
(0);

2317 } if(
pid
 < 0){

2318 
	`¥ötf
("%s: big¨gã°: f‹k faûed\n", 
s
);

2319 
	`exô
(1);

2322 
	`waô
(&
x°©us
);

2323 if(
x°©us
 != 0)

2324 
	`exô
(
x°©us
);

2325 
fd
 = 
	`›í
("bigarg-ok", 0);

2326 if(
fd
 < 0){

2327 
	`¥ötf
("%s: big¨gÅe° faûed!\n", 
s
);

2328 
	`exô
(1);

2330 
	`˛o£
(
fd
);

2331 
	}
}

2336 
	$fsfuŒ
()

2338 
nfûes
;

2339 
fsblocks
 = 0;

2341 
	`¥ötf
("fsfullÅest\n");

2343 
nfûes
 = 0; ;Çfiles++){

2344 
«me
[64];

2345 
«me
[0] = 'f';

2346 
«me
[1] = '0' + 
nfûes
 / 1000;

2347 
«me
[2] = '0' + (
nfûes
 % 1000) / 100;

2348 
«me
[3] = '0' + (
nfûes
 % 100) / 10;

2349 
«me
[4] = '0' + (
nfûes
 % 10);

2350 
«me
[5] = '\0';

2351 
	`¥ötf
("wrôög %s\n", 
«me
);

2352 
fd
 = 
	`›í
(
«me
, 
O_CREATE
|
O_RDWR
);

2353 if(
fd
 < 0){

2354 
	`¥ötf
("›í %†Áûed\n", 
«me
);

2357 
tŸÆ
 = 0;

2359 
cc
 = 
	`wrôe
(
fd
, 
buf
, 
BSIZE
);

2360 if(
cc
 < 
BSIZE
)

2362 
tŸÆ
 +
cc
;

2363 
fsblocks
++;

2365 
	`¥ötf
("wrŸê%d byãs\n", 
tŸÆ
);

2366 
	`˛o£
(
fd
);

2367 if(
tŸÆ
 == 0)

2371 
nfûes
 >= 0){

2372 
«me
[64];

2373 
«me
[0] = 'f';

2374 
«me
[1] = '0' + 
nfûes
 / 1000;

2375 
«me
[2] = '0' + (
nfûes
 % 1000) / 100;

2376 
«me
[3] = '0' + (
nfûes
 % 100) / 10;

2377 
«me
[4] = '0' + (
nfûes
 % 10);

2378 
«me
[5] = '\0';

2379 
	`u∆ök
(
«me
);

2380 
nfûes
--;

2383 
	`¥ötf
("fsfullÅest finished\n");

2384 
	}
}

2386 
	$¨g±e°
(*
s
)

2388 
fd
;

2389 
fd
 = 
	`›í
("öô", 
O_RDONLY
);

2390 i‡(
fd
 < 0) {

2391 
	`¥ötf
("%s: o≥¿Áûed\n", 
s
);

2392 
	`exô
(1);

2394 
	`ªad
(
fd
, 
	`sbrk
(0) - 1, -1);

2395 
	`˛o£
(
fd
);

2396 
	}
}

2401 
	$°ackã°
(*
s
)

2403 
pid
;

2404 
x°©us
;

2406 
pid
 = 
	`f‹k
();

2407 if(
pid
 == 0) {

2408 *
•
 = (*Ë
	`r_•
();

2409 
•
 -
PGSIZE
;

2411 
	`¥ötf
("%s: sèckã°:Ñód bñow sèck %p\n", 
s
, *
•
);

2412 
	`exô
(1);

2413 } if(
pid
 < 0){

2414 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

2415 
	`exô
(1);

2417 
	`waô
(&
x°©us
);

2418 if(
x°©us
 == -1)

2419 
	`exô
(0);

2421 
	`exô
(
x°©us
);

2422 
	}
}

2426 
	$ãxtwrôe
(*
s
)

2428 
pid
;

2429 
x°©us
;

2431 
pid
 = 
	`f‹k
();

2432 if(
pid
 == 0) {

2433 vﬁ©ûê*
addr
 = (*) 0;

2434 *
addr
 = 10;

2435 
	`exô
(1);

2436 } if(
pid
 < 0){

2437 
	`¥ötf
("%s: f‹k faûed\n", 
s
);

2438 
	`exô
(1);

2440 
	`waô
(&
x°©us
);

2441 if(
x°©us
 == -1)

2442 
	`exô
(0);

2444 
	`exô
(
x°©us
);

2445 
	}
}

2450 *
	gbig
 = (*) 0xeaeb0b5b00002f5e;

2452 
	$pgbug
(*
s
)

2454 *
¨gv
[1];

2455 
¨gv
[0] = 0;

2456 
	`exec
(
big
, 
¨gv
);

2457 
	`pùe
(
big
);

2459 
	`exô
(0);

2460 
	}
}

2466 
	$sbrkbugs
(*
s
)

2468 
pid
 = 
	`f‹k
();

2469 if(
pid
 < 0){

2470 
	`¥ötf
("fork failed\n");

2471 
	`exô
(1);

2473 if(
pid
 == 0){

2474 
sz
 = (
uöt64
Ë
	`sbrk
(0);

2478 
	`sbrk
(-
sz
);

2480 
	`exô
(0);

2482 
	`waô
(0);

2484 
pid
 = 
	`f‹k
();

2485 if(
pid
 < 0){

2486 
	`¥ötf
("fork failed\n");

2487 
	`exô
(1);

2489 if(
pid
 == 0){

2490 
sz
 = (
uöt64
Ë
	`sbrk
(0);

2494 
	`sbrk
(-(
sz
 - 3500));

2495 
	`exô
(0);

2497 
	`waô
(0);

2499 
pid
 = 
	`f‹k
();

2500 if(
pid
 < 0){

2501 
	`¥ötf
("fork failed\n");

2502 
	`exô
(1);

2504 if(
pid
 == 0){

2506 
	`sbrk
((10*4096 + 2048Ë- (
uöt64
)sbrk(0));

2511 
	`sbrk
(-10);

2513 
	`exô
(0);

2515 
	`waô
(0);

2517 
	`exô
(0);

2518 
	}
}

2524 
	$sbrkœ°
(*
s
)

2526 
uöt64
 
t›
 = (uöt64Ë
	`sbrk
(0);

2527 if((
t›
 % 4096) != 0)

2528 
	`sbrk
(4096 - (
t›
 % 4096));

2529 
	`sbrk
(4096);

2530 
	`sbrk
(10);

2531 
	`sbrk
(-20);

2532 
t›
 = (
uöt64
Ë
	`sbrk
(0);

2533 *
p
 = (*Ë(
t›
 - 64);

2534 
p
[0] = 'x';

2535 
p
[1] = '\0';

2536 
fd
 = 
	`›í
(
p
, 
O_RDWR
|
O_CREATE
);

2537 
	`wrôe
(
fd
, 
p
, 1);

2538 
	`˛o£
(
fd
);

2539 
fd
 = 
	`›í
(
p
, 
O_RDWR
);

2540 
p
[0] = '\0';

2541 
	`ªad
(
fd
, 
p
, 1);

2542 if(
p
[0] != 'x')

2543 
	`exô
(1);

2544 
	}
}

2550 
	$sbrk8000
(*
s
)

2552 
	`sbrk
(0x80000004);

2553 vﬁ©ûê*
t›
 = 
	`sbrk
(0);

2554 *(
t›
-1) = *(top-1) + 1;

2555 
	}
}

2562 
	$bad¨g
(*
s
)

2564 
i
 = 0; i < 50000; i++){

2565 *
¨gv
[2];

2566 
¨gv
[0] = (*)0xffffffff;

2567 
¨gv
[1] = 0;

2568 
	`exec
("echo", 
¨gv
);

2571 
	`exô
(0);

2572 
	}
}

2574 
	sã°
 {

2575 (*
	mf
)(*);

2576 *
	ms
;

2577 } 
	gquickã°s
[] = {

2578 {
c›yö
, "copyin"},

2579 {
c›yout
, "copyout"},

2580 {
c›yö°r1
, "copyinstr1"},

2581 {
c›yö°r2
, "copyinstr2"},

2582 {
c›yö°r3
, "copyinstr3"},

2583 {
rwsbrk
, "rwsbrk" },

2584 {
åunˇã1
, "truncate1"},

2585 {
åunˇã2
, "truncate2"},

2586 {
åunˇã3
, "truncate3"},

2587 {
›íùuâe°
, "openiput"},

2588 {
exôùuâe°
, "exitiput"},

2589 {
ùuâe°
, "iput"},

2590 {
›íã°
, "opentest"},

2591 {
wrôëe°
, "writetest"},

2592 {
wrôebig
, "writebig"},

2593 {
¸óãã°
, "createtest"},

2594 {
dúã°
, "dirtest"},

2595 {
exe˘e°
, "exectest"},

2596 {
pùe1
, "pipe1"},

2597 {
kûl°©us
, "killstatus"},

2598 {
¥ìm±
, "preempt"},

2599 {
exôwaô
, "exitwait"},

2600 {
ª∑ª¡
, "reparent" },

2601 {
twochûdªn
, "twochildren"},

2602 {
f‹kf‹k
, "forkfork"},

2603 {
f‹kf‹kf‹k
, "forkforkfork"},

2604 {
ª∑ª¡2
, "reparent2"},

2605 {
mem
, "mem"},

2606 {
sh¨edfd
, "sharedfd"},

2607 {
fourfûes
, "fourfiles"},

2608 {
¸óãdñëe
, "createdelete"},

2609 {
u∆ökªad
, "unlinkread"},

2610 {
lökã°
, "linktest"},

2611 {
c⁄¸óã
, "concreate"},

2612 {
löku∆ök
, "linkunlink"},

2613 {
subdú
, "subdir"},

2614 {
bigwrôe
, "bigwrite"},

2615 {
bigfûe
, "bigfile"},

2616 {
fouπìn
, "fourteen"},

2617 {
rmdŸ
, "rmdot"},

2618 {
dúfûe
, "dirfile"},

2619 {
úef
, "iref"},

2620 {
f‹kã°
, "forktest"},

2621 {
sbrkbasic
, "sbrkbasic"},

2622 {
sbrkmuch
, "sbrkmuch"},

2623 {
kînmem
, "kernmem"},

2624 {
MAXVA∂us
, "MAXVAplus"},

2625 {
sbrkÁû
, "sbrkfail"},

2626 {
sbrk¨g
, "sbrkarg"},

2627 {
vÆid©ëe°
, "validatetest"},

2628 {
bs°e°
, "bsstest"},

2629 {
big¨gã°
, "bigargtest"},

2630 {
¨g±e°
, "argptest"},

2631 {
°ackã°
, "stacktest"},

2632 {
ãxtwrôe
, "textwrite"},

2633 {
pgbug
, "pgbug" },

2634 {
sbrkbugs
, "sbrkbugs" },

2635 {
sbrkœ°
, "sbrklast"},

2636 {
sbrk8000
, "sbrk8000"},

2637 {
bad¨g
, "badarg" },

2648 
	$bigdú
(*
s
)

2650 íum { 
N
 = 500 };

2651 
i
, 
fd
;

2652 
«me
[10];

2654 
	`u∆ök
("bd");

2656 
fd
 = 
	`›í
("bd", 
O_CREATE
);

2657 if(
fd
 < 0){

2658 
	`¥ötf
("%s: bigdú cª©êÁûed\n", 
s
);

2659 
	`exô
(1);

2661 
	`˛o£
(
fd
);

2663 
i
 = 0; i < 
N
; i++){

2664 
«me
[0] = 'x';

2665 
«me
[1] = '0' + (
i
 / 64);

2666 
«me
[2] = '0' + (
i
 % 64);

2667 
«me
[3] = '\0';

2668 if(
	`lök
("bd", 
«me
) != 0){

2669 
	`¥ötf
("%s: bigdúÜök(bd, %sËÁûed\n", 
s
, 
«me
);

2670 
	`exô
(1);

2674 
	`u∆ök
("bd");

2675 
i
 = 0; i < 
N
; i++){

2676 
«me
[0] = 'x';

2677 
«me
[1] = '0' + (
i
 / 64);

2678 
«me
[2] = '0' + (
i
 % 64);

2679 
«me
[3] = '\0';

2680 if(
	`u∆ök
(
«me
) != 0){

2681 
	`¥ötf
("%s: bigdú u∆ök faûed", 
s
);

2682 
	`exô
(1);

2685 
	}
}

2690 
	$m™ywrôes
(*
s
)

2692 
nchûdªn
 = 4;

2693 
howm™y
 = 30;

2695 
ci
 = 0; cò< 
nchûdªn
; ci++){

2696 
pid
 = 
	`f‹k
();

2697 if(
pid
 < 0){

2698 
	`¥ötf
("fork failed\n");

2699 
	`exô
(1);

2702 if(
pid
 == 0){

2703 
«me
[3];

2704 
«me
[0] = 'b';

2705 
«me
[1] = 'a' + 
ci
;

2706 
«me
[2] = '\0';

2707 
	`u∆ök
(
«me
);

2709 
ôîs
 = 0; iãr†< 
howm™y
; iters++){

2710 
i
 = 0; i < 
ci
+1; i++){

2711 
fd
 = 
	`›í
(
«me
, 
O_CREATE
 | 
O_RDWR
);

2712 if(
fd
 < 0){

2713 
	`¥ötf
("%s: c™nŸ cª©ê%s\n", 
s
, 
«me
);

2714 
	`exô
(1);

2716 
sz
 = (
buf
);

2717 
cc
 = 
	`wrôe
(
fd
, 
buf
, 
sz
);

2718 if(
cc
 !
sz
){

2719 
	`¥ötf
("%s: wrôe(%dËªà%d\n", 
s
, 
sz
, 
cc
);

2720 
	`exô
(1);

2722 
	`˛o£
(
fd
);

2724 
	`u∆ök
(
«me
);

2727 
	`u∆ök
(
«me
);

2728 
	`exô
(0);

2732 
ci
 = 0; cò< 
nchûdªn
; ci++){

2733 
°
 = 0;

2734 
	`waô
(&
°
);

2735 if(
°
 != 0)

2736 
	`exô
(
°
);

2738 
	`exô
(0);

2739 
	}
}

2747 
	$badwrôe
(*
s
)

2749 
assumed_‰ì
 = 600;

2751 
	`u∆ök
("junk");

2752 
i
 = 0; i < 
assumed_‰ì
; i++){

2753 
fd
 = 
	`›í
("junk", 
O_CREATE
|
O_WRONLY
);

2754 if(
fd
 < 0){

2755 
	`¥ötf
("open junk failed\n");

2756 
	`exô
(1);

2758 
	`wrôe
(
fd
, (*)0xffffffffffL, 1);

2759 
	`˛o£
(
fd
);

2760 
	`u∆ök
("junk");

2763 
fd
 = 
	`›í
("junk", 
O_CREATE
|
O_WRONLY
);

2764 if(
fd
 < 0){

2765 
	`¥ötf
("open junk failed\n");

2766 
	`exô
(1);

2768 if(
	`wrôe
(
fd
, "x", 1) != 1){

2769 
	`¥ötf
("write failed\n");

2770 
	`exô
(1);

2772 
	`˛o£
(
fd
);

2773 
	`u∆ök
("junk");

2775 
	`exô
(0);

2776 
	}
}

2782 
	$execout
(*
s
)

2784 
avaû
 = 0;ávail < 15;ávail++){

2785 
pid
 = 
	`f‹k
();

2786 if(
pid
 < 0){

2787 
	`¥ötf
("fork failed\n");

2788 
	`exô
(1);

2789 } if(
pid
 == 0){

2792 
uöt64
 
a
 = (uöt64Ë
	`sbrk
(4096);

2793 if(
a
 == 0xffffffffffffffffLL)

2795 *(*)(
a
 + 4096 - 1) = 1;

2800 
i
 = 0; i < 
avaû
; i++)

2801 
	`sbrk
(-4096);

2803 
	`˛o£
(1);

2804 *
¨gs
[] = { "echo", "x", 0 };

2805 
	`exec
("echo", 
¨gs
);

2806 
	`exô
(0);

2808 
	`waô
((*)0);

2812 
	`exô
(0);

2813 
	}
}

2817 
	$diskfuŒ
(*
s
)

2819 
fi
;

2820 
d⁄e
 = 0;

2822 
	`u∆ök
("diskfulldir");

2824 
fi
 = 0; 
d⁄e
 == 0; fi++){

2825 
«me
[32];

2826 
«me
[0] = 'b';

2827 
«me
[1] = 'i';

2828 
«me
[2] = 'g';

2829 
«me
[3] = '0' + 
fi
;

2830 
«me
[4] = '\0';

2831 
	`u∆ök
(
«me
);

2832 
fd
 = 
	`›í
(
«me
, 
O_CREATE
|
O_RDWR
|
O_TRUNC
);

2833 if(
fd
 < 0){

2835 
	`¥ötf
("%s: couldÇŸ cª©êfûê%s\n", 
s
, 
«me
);

2836 
d⁄e
 = 1;

2839 
i
 = 0; i < 
MAXFILE
; i++){

2840 
buf
[
BSIZE
];

2841 if(
	`wrôe
(
fd
, 
buf
, 
BSIZE
) != BSIZE){

2842 
d⁄e
 = 1;

2843 
	`˛o£
(
fd
);

2847 
	`˛o£
(
fd
);

2854 
nzz
 = 128;

2855 
i
 = 0; i < 
nzz
; i++){

2856 
«me
[32];

2857 
«me
[0] = 'z';

2858 
«me
[1] = 'z';

2859 
«me
[2] = '0' + (
i
 / 32);

2860 
«me
[3] = '0' + (
i
 % 32);

2861 
«me
[4] = '\0';

2862 
	`u∆ök
(
«me
);

2863 
fd
 = 
	`›í
(
«me
, 
O_CREATE
|
O_RDWR
|
O_TRUNC
);

2864 if(
fd
 < 0)

2866 
	`˛o£
(
fd
);

2870 if(
	`mkdú
("diskfulldir") == 0)

2871 
	`¥ötf
("%s: mkdir(diskfulldir) unexpectedly succeeded!\n");

2873 
	`u∆ök
("diskfulldir");

2875 
i
 = 0; i < 
nzz
; i++){

2876 
«me
[32];

2877 
«me
[0] = 'z';

2878 
«me
[1] = 'z';

2879 
«me
[2] = '0' + (
i
 / 32);

2880 
«me
[3] = '0' + (
i
 % 32);

2881 
«me
[4] = '\0';

2882 
	`u∆ök
(
«me
);

2885 
i
 = 0; i < 
fi
; i++){

2886 
«me
[32];

2887 
«me
[0] = 'b';

2888 
«me
[1] = 'i';

2889 
«me
[2] = 'g';

2890 
«me
[3] = '0' + 
i
;

2891 
«me
[4] = '\0';

2892 
	`u∆ök
(
«me
);

2894 
	}
}

2897 
	$outoföodes
(*
s
)

2899 
nzz
 = 32*32;

2900 
i
 = 0; i < 
nzz
; i++){

2901 
«me
[32];

2902 
«me
[0] = 'z';

2903 
«me
[1] = 'z';

2904 
«me
[2] = '0' + (
i
 / 32);

2905 
«me
[3] = '0' + (
i
 % 32);

2906 
«me
[4] = '\0';

2907 
	`u∆ök
(
«me
);

2908 
fd
 = 
	`›í
(
«me
, 
O_CREATE
|
O_RDWR
|
O_TRUNC
);

2909 if(
fd
 < 0){

2913 
	`˛o£
(
fd
);

2916 
i
 = 0; i < 
nzz
; i++){

2917 
«me
[32];

2918 
«me
[0] = 'z';

2919 
«me
[1] = 'z';

2920 
«me
[2] = '0' + (
i
 / 32);

2921 
«me
[3] = '0' + (
i
 % 32);

2922 
«me
[4] = '\0';

2923 
	`u∆ök
(
«me
);

2925 
	}
}

2927 
ã°
 
	g¶owã°s
[] = {

2928 {
bigdú
, "bigdir"},

2929 {
m™ywrôes
, "manywrites"},

2930 {
badwrôe
, "badwrite" },

2931 {
execout
, "execout"},

2932 {
diskfuŒ
, "diskfull"},

2933 {
outoföodes
, "outofinodes"},

2945 
run
(
f
(*), *
s
) {

2946 
	gpid
;

2947 
	gx°©us
;

2949 
¥ötf
("ã° %s: ", 
s
);

2950 if((
	gpid
 = 
f‹k
()) < 0) {

2951 
¥ötf
("runtest: forkÉrror\n");

2952 
exô
(1);

2954 if(
	gpid
 == 0) {

2955 
f
(
s
);

2956 
exô
(0);

2958 
waô
(&
x°©us
);

2959 if(
	gx°©us
 != 0)

2960 
¥ötf
("FAILED\n");

2962 
¥ötf
("OK\n");

2963  
	gx°©us
 == 0;

2968 
	$ru¡e°s
(
ã°
 *
ã°s
, *
ju°⁄e
) {

2969 
ã°
 *
t
 = 
ã°s
;Å->
s
 != 0;Å++) {

2970 if((
ju°⁄e
 =0Ë|| 
	`°rcmp
(
t
->
s
, justone) == 0) {

2971 if(!
	`run
(
t
->
f
,Å->
s
)){

2972 
	`¥ötf
("SOME TESTS FAILED\n");

2978 
	}
}

2988 
	$cou¡‰ì
()

2990 
fds
[2];

2992 if(
	`pùe
(
fds
) < 0){

2993 
	`¥ötf
("pipe() failed in countfree()\n");

2994 
	`exô
(1);

2997 
pid
 = 
	`f‹k
();

2999 if(
pid
 < 0){

3000 
	`¥ötf
("fork failed in countfree()\n");

3001 
	`exô
(1);

3004 if(
pid
 == 0){

3005 
	`˛o£
(
fds
[0]);

3008 
uöt64
 
a
 = (uöt64Ë
	`sbrk
(4096);

3009 if(
a
 == 0xffffffffffffffff){

3014 *(*)(
a
 + 4096 - 1) = 1;

3017 if(
	`wrôe
(
fds
[1], "x", 1) != 1){

3018 
	`¥ötf
("write() failed in countfree()\n");

3019 
	`exô
(1);

3023 
	`exô
(0);

3026 
	`˛o£
(
fds
[1]);

3028 
n
 = 0;

3030 
c
;

3031 
cc
 = 
	`ªad
(
fds
[0], &
c
, 1);

3032 if(
cc
 < 0){

3033 
	`¥ötf
("read() failed in countfree()\n");

3034 
	`exô
(1);

3036 if(
cc
 == 0)

3038 
n
 += 1;

3041 
	`˛o£
(
fds
[0]);

3042 
	`waô
((*)0);

3044  
n
;

3045 
	}
}

3048 
	$drivëe°s
(
quick
, 
c⁄töuous
, *
ju°⁄e
) {

3050 
	`¥ötf
("usertests starting\n");

3051 
‰ì0
 = 
	`cou¡‰ì
();

3052 
‰ì1
 = 0;

3053 i‡(
	`ru¡e°s
(
quickã°s
, 
ju°⁄e
)) {

3054 if(
c⁄töuous
 != 2) {

3058 if(!
quick
) {

3059 i‡(
ju°⁄e
 == 0)

3060 
	`¥ötf
("usertests slowÅests starting\n");

3061 i‡(
	`ru¡e°s
(
¶owã°s
, 
ju°⁄e
)) {

3062 if(
c⁄töuous
 != 2) {

3067 if((
‰ì1
 = 
	`cou¡‰ì
()Ë< 
‰ì0
) {

3068 
	`¥ötf
("FAILED --Üo° somê‰ìÖage†%d (ouào‡%d)\n", 
‰ì1
, 
‰ì0
);

3069 if(
c⁄töuous
 != 2) {

3073 } 
c⁄töuous
);

3075 
	}
}

3078 
	$maö
(
¨gc
, *
¨gv
[])

3080 
c⁄töuous
 = 0;

3081 
quick
 = 0;

3082 *
ju°⁄e
 = 0;

3084 if(
¨gc
 =2 && 
	`°rcmp
(
¨gv
[1], "-q") == 0){

3085 
quick
 = 1;

3086 } if(
¨gc
 =2 && 
	`°rcmp
(
¨gv
[1], "-c") == 0){

3087 
c⁄töuous
 = 1;

3088 } if(
¨gc
 =2 && 
	`°rcmp
(
¨gv
[1], "-C") == 0){

3089 
c⁄töuous
 = 2;

3090 } if(
¨gc
 =2 && 
¨gv
[1][0] != '-'){

3091 
ju°⁄e
 = 
¨gv
[1];

3092 } if(
¨gc
 > 1){

3093 
	`¥ötf
("Usage: usertests [-c] [-C] [-q] [testname]\n");

3094 
	`exô
(1);

3096 i‡(
	`drivëe°s
(
quick
, 
c⁄töuous
, 
ju°⁄e
)) {

3097 
	`exô
(1);

3099 
	`¥ötf
("ALL TESTS PASSED\n");

3100 
	`exô
(0);

3101 
	}
}

	@wc.c

1 
	~"kî√l/ty≥s.h
"

2 
	~"kî√l/°©.h
"

3 
	~"u£r/u£r.h
"

5 
	gbuf
[512];

8 
	$wc
(
fd
, *
«me
)

10 
i
, 
n
;

11 
l
, 
w
, 
c
, 
öw‹d
;

13 
l
 = 
w
 = 
c
 = 0;

14 
öw‹d
 = 0;

15 (
n
 = 
	`ªad
(
fd
, 
buf
, (buf))) > 0){

16 
i
=0; i<
n
; i++){

17 
c
++;

18 if(
buf
[
i
] == '\n')

19 
l
++;

20 if(
	`°rchr
(" \r\t\n\v", 
buf
[
i
]))

21 
öw‹d
 = 0;

22 if(!
öw‹d
){

23 
w
++;

24 
öw‹d
 = 1;

28 if(
n
 < 0){

29 
	`¥ötf
("wc:ÑeadÉrror\n");

30 
	`exô
(1);

32 
	`¥ötf
("%d %d %d %s\n", 
l
, 
w
, 
c
, 
«me
);

33 
	}
}

36 
	$maö
(
¨gc
, *
¨gv
[])

38 
fd
, 
i
;

40 if(
¨gc
 <= 1){

41 
	`wc
(0, "");

42 
	`exô
(0);

45 
i
 = 1; i < 
¨gc
; i++){

46 if((
fd
 = 
	`›í
(
¨gv
[
i
], 0)) < 0){

47 
	`¥ötf
("wc: c™nŸ o≥¿%s\n", 
¨gv
[
i
]);

48 
	`exô
(1);

50 
	`wc
(
fd
, 
¨gv
[
i
]);

51 
	`˛o£
(
fd
);

53 
	`exô
(0);

54 
	}
}

	@zombie.c

4 
	~"kî√l/ty≥s.h
"

5 
	~"kî√l/°©.h
"

6 
	~"u£r/u£r.h
"

9 
	$maö
()

11 if(
	`f‹k
() > 0)

12 
	`¶ìp
(5);

13 
	`exô
(0);

14 
	}
}

	@
1
.
1
/usr/include
22
170
cat.c
demo.c
echo.c
forkdemo.c
forktest.c
grep.c
grind.c
hello.c
init.c
kill.c
ln.c
ls.c
mkdir.c
printf.c
rm.c
sh.c
stressfs.c
ulib.c
umalloc.c
usertests.c
wc.c
zombie.c
